<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickPulse V2 - 产品状态明细表</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 950: '#0a0a0b' } },
                    fontFamily: {
                        sans: ['Geist', 'Noto Sans SC', 'system-ui'],
                        mono: ['Geist Mono', 'monospace']
                    }
                }
            }
        };
    </script>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body class="bg-slate-950 min-h-screen" x-data="authGuard()">
    <a href="#main-content"
       class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:bg-slate-900 focus:text-slate-50 focus:px-4 focus:py-2 focus:rounded">
        跳转到主要内容
    </a>

    <div x-data="mtoSearch()" x-init="init()" @keydown.escape.window="exitFullScreen()">
        <header class="bg-slate-900 border-b border-slate-800 px-6 py-4 no-print"
                :class="isFullScreen && isCollapsed ? 'hidden' : ''">
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-semibold text-slate-50 tracking-wide">QuickPulse</h1>
                    <span class="text-slate-600 text-sm">|</span>
                    <span class="text-slate-400 text-sm">产品状态明细表</span>
                </div>
                <div class="flex items-center gap-6">
                    <span class="text-slate-400 text-sm font-mono" x-text="new Date().toLocaleString('zh-CN')"></span>
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open"
                                class="flex items-center gap-2 text-slate-400 hover:text-slate-50 transition">
                            <i data-lucide="user" class="w-4 h-4"></i>
                            <span class="text-sm">用户</span>
                            <i data-lucide="chevron-down" class="w-3 h-3"></i>
                        </button>
                        <div x-show="open" @click.away="open = false" x-transition
                             class="absolute right-0 mt-2 w-40 bg-slate-800 border border-slate-700 rounded shadow-lg py-1 z-50">
                            <a href="/sync.html" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700">同步管理</a>
                            <button @click="api.logout()"
                                    class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-700">
                                退出登录
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="max-w-7xl mx-auto px-6 py-8" :class="isFullScreen ? 'max-w-full' : ''">
            <section :class="isFullScreen && isCollapsed ? 'hidden' : 'mb-8'" class="transition-all">
                <div class="flex gap-4 items-end">
                    <div class="flex-1 max-w-md">
                        <label for="mto-search" class="block text-sm text-slate-400 mb-2">MTO单号</label>
                        <input type="text" id="mto-search" x-model="mtoNumber" @keydown.enter="search()"
                               aria-label="计划跟踪号" aria-describedby="mto-help"
                               placeholder="输入计划跟踪号..."
                               class="w-full bg-slate-800 border border-slate-700 text-slate-50 px-4 py-3 rounded focus:outline-none glow-emerald transition font-mono"
                               :disabled="loading">
                        <p id="mto-help" class="sr-only">输入MTO跟踪号进行搜索，例如 AK2510034</p>
                        <div class="text-xs text-slate-600 mt-2">
                            提示: 按 <kbd class="px-1 bg-slate-800 rounded">/</kbd> 快速定位搜索框
                        </div>
                    </div>
                    <button @click="search()" :disabled="loading || !mtoNumber"
                            aria-label="搜索MTO单号"
                            class="px-6 py-3 bg-emerald-500 hover:bg-emerald-400 disabled:bg-slate-700 disabled:cursor-not-allowed text-slate-950 font-medium rounded transition flex items-center gap-2">
                        <span x-show="loading"
                              class="w-4 h-4 border-2 border-slate-950 border-t-transparent rounded-full animate-spin"></span>
                        <span x-text="loading ? '查询中...' : '查询'"></span>
                    </button>
                </div>
            </section>

            <div x-show="error" x-transition class="mb-6">
                <div class="p-4 bg-rose-500/10 border border-rose-500/30 rounded text-rose-400">
                    <span x-text="error"></span>
                </div>
            </div>
            <div x-show="successMessage" x-transition class="mb-6">
                <div class="p-4 bg-emerald-500/10 border border-emerald-500/30 rounded text-emerald-400">
                    <span x-text="successMessage"></span>
                </div>
            </div>

            <div x-show="parentItem" x-transition :class="isFullScreen && isCollapsed ? 'hidden' : 'mb-6'">
                <div class="bg-slate-900 border border-slate-800 rounded px-6 py-4">
                    <div class="flex items-center justify-between gap-6 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-slate-500">MTO</span>
                            <span class="text-slate-50 font-mono font-medium" x-text="parentItem?.mto_number"></span>
                        </div>
                        <div class="flex items-center gap-6">
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500">客户</span>
                                <span class="text-slate-200" x-text="parentItem?.customer_name || '-'"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500">交期</span>
                                <span class="text-slate-200" x-text="parentItem?.delivery_date ? parentItem.delivery_date.split('T')[0] : '-'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="childItems.length > 0" x-transition
                 class="bg-slate-900 border border-slate-800 rounded overflow-hidden">
                <div class="bg-slate-800 px-6 py-4 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-slate-50 flex items-center gap-2">
                        <i data-lucide="list" class="w-5 h-5"></i>
                        BOM组件明细
                        <span class="text-sm font-normal text-slate-400" x-text="`(${childItems.length} 条)`"></span>
                    </h2>
                    <div class="flex items-center gap-3">
                        <button x-show="isFullScreen" @click="isCollapsed = !isCollapsed"
                                class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-sm transition">
                            <span x-text="isCollapsed ? '展开' : '收起'"></span>
                        </button>
                        <button @click="exportToExcel()"
                                class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-slate-950 text-sm font-medium transition flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            导出
                        </button>
                        <button @click="toggleFullScreen()"
                                class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-sm transition flex items-center gap-2">
                            <i :data-lucide="isFullScreen ? 'minimize-2' : 'maximize-2'" class="w-4 h-4"></i>
                            <span x-text="isFullScreen ? '退出全屏' : '全屏'"></span>
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto overflow-y-auto bom-table" :class="isFullScreen ? 'max-h-[calc(100vh-120px)]' : 'max-h-[600px]'">
                    <table role="table" class="w-full text-sm">
                        <thead class="sticky top-0 z-10">
                            <tr role="row" class="border-b border-slate-700">
                                <th scope="col"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sticky left-0 z-20">序号</th>
                                <th scope="col"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap min-w-[120px]">物料编码</th>
                                <th scope="col"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap min-w-[150px]">物料名称</th>
                                <th scope="col"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap min-w-[120px]">规格型号</th>
                                <th scope="col"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap min-w-[150px]">辅助属性</th>
                                <th scope="col"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap">物料类型</th>
                                <th scope="col"
                                    class="px-4 py-3 text-right font-medium text-emerald-400 bg-slate-900 whitespace-nowrap border-l border-emerald-900">需求量</th>
                                <th scope="col"
                                    class="px-4 py-3 text-right font-medium text-slate-400 bg-slate-900 whitespace-nowrap">已领量</th>
                                <th scope="col"
                                    class="px-4 py-3 text-right font-medium text-slate-400 bg-slate-900 whitespace-nowrap border-r border-emerald-900">未领量</th>
                                <th scope="col"
                                    class="px-4 py-3 text-right font-medium text-sky-400 bg-slate-900 whitespace-nowrap border-l border-sky-900">订单数量</th>
                                <th scope="col"
                                    class="px-4 py-3 text-right font-medium text-slate-400 bg-slate-900 whitespace-nowrap">入库量</th>
                                <th scope="col"
                                    class="px-4 py-3 text-right font-medium text-slate-400 bg-slate-900 whitespace-nowrap border-r border-sky-900">未入库量</th>
                                <th scope="col"
                                    class="px-4 py-3 text-right font-medium text-violet-400 bg-slate-900 whitespace-nowrap border-l border-violet-900">销售出库</th>
                                <th scope="col"
                                    class="px-4 py-3 text-right font-medium text-slate-400 bg-slate-900 whitespace-nowrap">即时库存</th>
                            </tr>
                        </thead>
                        <tbody role="rowgroup">
                            <template x-for="(item, index) in childItems" :key="index">
                                <tr role="row" class="border-b border-slate-800 hover:bg-slate-800/50 transition"
                                    :class="isOverPicked(item.unpicked_qty) ? 'row-overpick' : ''">
                                    <td role="cell" class="px-4 py-3 text-slate-500 bg-slate-900 sticky left-0 z-[5]" x-text="index + 1"></td>
                                    <td role="cell" class="px-4 py-3 font-mono text-sm text-slate-300" x-text="item.material_code"></td>
                                    <td role="cell" class="px-4 py-3 text-slate-200" x-text="item.material_name"></td>
                                    <td role="cell" class="px-4 py-3 text-slate-400" x-text="item.specification || '-'"></td>
                                    <td role="cell" class="px-4 py-3 text-slate-400 text-xs max-w-[200px] truncate"
                                        :title="item.aux_attributes || ''"
                                        x-text="item.aux_attributes || '-'"></td>
                                    <td role="cell" class="px-4 py-3">
                                        <span class="px-2 py-1 rounded text-xs font-medium"
                                              :class="getMaterialTypeBadge(item.material_type)"
                                              x-text="item.material_type"></span>
                                    </td>
                                    <td role="cell"
                                        class="px-4 py-3 text-right font-medium text-slate-200 bg-emerald-950/10"
                                        x-text="formatNumber(item.required_qty)"></td>
                                    <td role="cell" class="px-4 py-3 text-right text-slate-300 bg-emerald-950/10"
                                        x-text="formatNumber(item.picked_qty)"></td>
                                    <td role="cell" class="px-4 py-3 text-right font-medium bg-emerald-950/10"
                                        :class="isOverPicked(item.unpicked_qty) ? 'text-rose-400 font-bold' : 'text-slate-200'">
                                        <span x-text="formatNumber(item.unpicked_qty)"></span>
                                        <span x-show="isOverPicked(item.unpicked_qty)" class="text-xs ml-1 text-rose-500">(超领)</span>
                                    </td>
                                    <td role="cell" class="px-4 py-3 text-right text-slate-300 bg-sky-950/10"
                                        x-text="formatNumber(item.order_qty)"></td>
                                    <td role="cell" class="px-4 py-3 text-right text-slate-300 bg-sky-950/10"
                                        x-text="formatNumber(item.received_qty)"></td>
                                    <td role="cell" class="px-4 py-3 text-right font-medium bg-sky-950/10"
                                        :class="item.unreceived_qty > 0 ? 'text-amber-400' : 'text-emerald-400'"
                                        x-text="formatNumber(item.unreceived_qty)"></td>
                                    <td role="cell" class="px-4 py-3 text-right text-slate-300 bg-violet-950/10"
                                        x-text="formatNumber(item.sales_outbound_qty)"></td>
                                    <td role="cell" class="px-4 py-3 text-right font-medium bg-violet-950/10"
                                        :class="item.current_stock <= 0 ? 'text-rose-400' : 'text-slate-200'"
                                        x-text="formatNumber(item.current_stock)"></td>
                                </tr>
                            </template>
                        </tbody>
                        <tfoot class="sticky bottom-0 z-10">
                            <tr class="border-t-2 border-slate-600 bg-slate-800 font-semibold">
                                <td class="px-4 py-3 text-slate-400 bg-slate-800 sticky left-0 z-20">合计</td>
                                <td colspan="5" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <td class="px-4 py-3 text-right text-emerald-400 bg-slate-800"
                                    x-text="formatNumber(childItems.reduce((sum, i) => sum + parseFloat(i.required_qty || 0), 0))"></td>
                                <td class="px-4 py-3 text-right text-slate-300 bg-slate-800"
                                    x-text="formatNumber(childItems.reduce((sum, i) => sum + parseFloat(i.picked_qty || 0), 0))"></td>
                                <td class="px-4 py-3 text-right text-slate-300 bg-slate-800"
                                    x-text="formatNumber(childItems.reduce((sum, i) => sum + parseFloat(i.unpicked_qty || 0), 0))"></td>
                                <td class="px-4 py-3 text-right text-sky-400 bg-slate-800"
                                    x-text="formatNumber(childItems.reduce((sum, i) => sum + parseFloat(i.order_qty || 0), 0))"></td>
                                <td class="px-4 py-3 text-right text-slate-300 bg-slate-800"
                                    x-text="formatNumber(childItems.reduce((sum, i) => sum + parseFloat(i.received_qty || 0), 0))"></td>
                                <td class="px-4 py-3 text-right text-slate-300 bg-slate-800"
                                    x-text="formatNumber(childItems.reduce((sum, i) => sum + parseFloat(i.unreceived_qty || 0), 0))"></td>
                                <td class="px-4 py-3 text-right text-violet-400 bg-slate-800"
                                    x-text="formatNumber(childItems.reduce((sum, i) => sum + parseFloat(i.sales_outbound_qty || 0), 0))"></td>
                                <td class="px-4 py-3 text-right text-slate-300 bg-slate-800"
                                    x-text="formatNumber(childItems.reduce((sum, i) => sum + parseFloat(i.current_stock || 0), 0))"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="bom-cards md:hidden">
                    <template x-for="(item, index) in childItems" :key="`card-${index}`">
                        <div class="bom-card" :class="isOverPicked(item.unpicked_qty) ? 'row-overpick' : ''">
                            <div class="bom-card-header">
                                <div>
                                    <div class="font-mono text-sm text-slate-300" x-text="item.material_code"></div>
                                    <div class="text-slate-200 mt-1" x-text="item.material_name"></div>
                                    <div class="text-slate-500 text-xs mt-1" x-show="item.aux_attributes" x-text="item.aux_attributes"></div>
                                </div>
                                <span class="px-2 py-1 rounded text-xs font-medium"
                                      :class="getMaterialTypeBadge(item.material_type)"
                                      x-text="item.material_type"></span>
                            </div>
                            <div class="bom-card-grid">
                                <div class="bom-card-item">
                                    <span class="bom-card-label">需求量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.required_qty)"></span>
                                </div>
                                <div class="bom-card-item">
                                    <span class="bom-card-label">已领量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.picked_qty)"></span>
                                </div>
                                <div class="bom-card-item">
                                    <span class="bom-card-label">未领量</span>
                                    <span class="bom-card-value"
                                          :class="isOverPicked(item.unpicked_qty) ? 'text-rose-400 font-bold' : ''"
                                          x-text="formatNumber(item.unpicked_qty) + (isOverPicked(item.unpicked_qty) ? ' (超领)' : '')"></span>
                                </div>
                                <div class="bom-card-item">
                                    <span class="bom-card-label">即时库存</span>
                                    <span class="bom-card-value" :class="item.current_stock <= 0 ? 'text-rose-400' : ''"
                                          x-text="formatNumber(item.current_stock)"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="bg-slate-800/50 px-6 py-4 border-t border-slate-700">
                    <div class="flex items-center justify-between text-sm">
                        <div class="text-slate-400">
                            共 <span class="font-bold text-slate-200" x-text="childItems.length"></span> 条记录
                        </div>
                        <div class="flex items-center gap-6 text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-rose-500 rounded"></div>
                                <span class="text-slate-400">超领</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-amber-500 rounded"></div>
                                <span class="text-slate-400">待入库</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-emerald-500 rounded"></div>
                                <span class="text-slate-400">已完成</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="childItems.length > 0" x-transition
                 class="mt-6 bg-slate-900 border border-slate-800 rounded overflow-hidden">
                <div class="bg-slate-800 px-6 py-4 flex items-center justify-between cursor-pointer"
                     @click="relatedOrdersExpanded = !relatedOrdersExpanded">
                    <h2 class="text-lg font-semibold text-slate-50 flex items-center gap-2">
                        <i data-lucide="share-2" class="w-5 h-5"></i>
                        订单关联图
                    </h2>
                    <div class="flex items-center gap-2 text-sm text-slate-400">
                        <span x-text="relatedOrdersExpanded ? '收起' : '展开'"></span>
                        <i :data-lucide="relatedOrdersExpanded ? 'chevron-up' : 'chevron-down'" class="w-4 h-4"></i>
                    </div>
                </div>

                <div x-show="relatedOrdersExpanded" class="p-6 space-y-4">
                    <div x-show="relatedOrdersLoading" class="text-slate-400 text-sm">
                        正在加载关联单据...
                    </div>
                    <div x-show="relatedOrdersError" class="text-rose-400 text-sm" x-text="relatedOrdersError"></div>

                    <template x-if="!relatedOrdersLoading && hasRelatedOrders()">
                        <div class="tree-container">
                            <div class="tree-node tree-root">
                                <span class="tree-label">MTO号</span>
                                <span class="tree-value" x-text="mtoNumber"></span>
                            </div>
                            <div class="tree-children">
                                <div class="space-y-3">
                                    <template x-for="order in relatedOrders.orders.sales_orders" :key="`so-${order.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-sales">
                                                <span class="tree-label" x-text="order.label"></span>
                                                <span class="tree-value" x-text="order.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="doc in relatedOrders.documents.sales_deliveries" :key="`sd-${doc.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-sales tree-doc">
                                                <span class="tree-label" x-text="doc.label"></span>
                                                <span class="tree-value" x-text="doc.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <div class="space-y-3">
                                    <template x-for="order in relatedOrders.orders.production_orders" :key="`po-${order.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-production">
                                                <span class="tree-label" x-text="order.label"></span>
                                                <span class="tree-value" x-text="order.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="doc in relatedOrders.documents.production_receipts" :key="`pr-${doc.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-production tree-doc">
                                                <span class="tree-label" x-text="doc.label"></span>
                                                <span class="tree-value" x-text="doc.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="doc in relatedOrders.documents.material_pickings" :key="`mp-${doc.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-production tree-doc">
                                                <span class="tree-label" x-text="doc.label"></span>
                                                <span class="tree-value" x-text="doc.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <div class="space-y-3">
                                    <template x-for="order in relatedOrders.orders.purchase_orders" :key="`pu-${order.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-purchase">
                                                <span class="tree-label" x-text="order.label"></span>
                                                <span class="tree-value" x-text="order.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="doc in relatedOrders.documents.purchase_receipts" :key="`prc-${doc.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-purchase tree-doc">
                                                <span class="tree-label" x-text="doc.label"></span>
                                                <span class="tree-value" x-text="doc.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="!relatedOrdersLoading && !relatedOrdersError && !hasRelatedOrders()" class="text-slate-500 text-sm">
                        暂无关联单据
                    </div>
                </div>
            </div>

            <div x-show="loading" class="bg-slate-900 border border-slate-800 rounded p-6">
                <div class="space-y-4">
                    <template x-for="i in 5" :key="i">
                        <div class="flex gap-4">
                            <div class="skeleton h-4 w-12 rounded"></div>
                            <div class="skeleton h-4 w-32 rounded"></div>
                            <div class="skeleton h-4 flex-1 rounded"></div>
                            <div class="skeleton h-4 w-20 rounded"></div>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="!loading && childItems.length === 0 && !error" class="text-center py-20">
                <i data-lucide="inbox" class="w-16 h-16 text-slate-700 mx-auto mb-4"></i>
                <h3 class="text-lg text-slate-400 mb-2">暂无数据</h3>
                <p class="text-slate-600 text-sm">请输入MTO单号进行查询</p>
            </div>
        </main>

        <div class="fixed bottom-4 right-4 text-xs text-slate-600 no-print" x-show="childItems.length > 0">
            <span class="px-2 py-1 bg-slate-800 rounded mr-1">F11</span> 全屏
            <span class="px-2 py-1 bg-slate-800 rounded mr-1 ml-2">ESC</span> 退出
        </div>

        <div aria-live="polite" aria-atomic="true" class="sr-only"
             x-text="loading ? '正在加载...' : (error ? '发生错误: ' + error : (parentItem ? '已加载MTO单号 ' + mtoNumber + ' 的数据' : ''))">
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script>lucide.createIcons();</script>
</body>
</html>
