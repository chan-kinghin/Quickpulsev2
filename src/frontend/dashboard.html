<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickPulse V2 - 产品状态明细表</title>

    <!-- Use system fonts for reliability in China (no Google Fonts dependency) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 950: '#0a0a0b' } },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', 'Hiragino Sans GB', 'sans-serif'],
                        mono: ['SFMono-Regular', 'Consolas', 'Liberation Mono', 'monospace']
                    }
                }
            }
        };
    </script>

    <!-- Serve Alpine.js locally for reliability in China -->
    <script defer src="/static/js/alpine.min.js"></script>
    <script src="/static/js/lucide.min.js"></script>
    <!-- SheetJS for Excel export (served locally for China reliability) -->
    <script src="/static/js/xlsx.full.min.js"></script>

    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body class="bg-slate-950 min-h-screen" x-data="authGuard()">
    <a href="#main-content"
       class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:bg-slate-900 focus:text-slate-50 focus:px-4 focus:py-2 focus:rounded">
        跳转到主要内容
    </a>

    <div x-data="mtoSearch()" x-init="init()" x-cloak @keydown.escape.window="exitFullScreen()">
        <header class="bg-slate-900 border-b border-slate-800 px-6 py-4 no-print"
                :class="isFullScreen && isCollapsed ? 'hidden' : ''">
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-semibold text-slate-50 tracking-wide">QuickPulse</h1>
                    <span class="text-slate-600 text-sm">|</span>
                    <span class="text-slate-400 text-sm">产品状态明细表</span>
                </div>
                <div class="flex items-center gap-6">
                    <span class="text-slate-400 text-sm font-mono" x-text="new Date().toLocaleString('zh-CN')"></span>
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open"
                                class="flex items-center gap-2 text-slate-400 hover:text-slate-50 transition">
                            <i data-lucide="user" class="w-4 h-4"></i>
                            <span class="text-sm">用户</span>
                            <i data-lucide="chevron-down" class="w-3 h-3"></i>
                        </button>
                        <div x-show="open" @click.away="open = false" x-transition
                             class="absolute right-0 mt-2 w-40 bg-slate-800 border border-slate-700 rounded shadow-lg py-1 z-50">
                            <a href="/sync.html" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700">同步管理</a>
                            <button @click="api.logout()"
                                    class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-700">
                                退出登录
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="max-w-7xl mx-auto px-6 py-8" :class="isFullScreen ? 'max-w-full' : ''">
            <section :class="isFullScreen && isCollapsed ? 'hidden' : 'mb-8'" class="transition-all">
                <div class="flex gap-4 items-end">
                    <div class="flex-1 max-w-md relative">
                        <label for="mto-search" class="block text-sm text-slate-400 mb-2">MTO单号</label>
                        <input type="text" id="mto-search" x-model="mtoNumber"
                               @keydown.enter="search()"
                               @focus="showSearchHistory = searchHistory.length > 0"
                               @blur="setTimeout(() => showSearchHistory = false, 200)"
                               aria-label="计划跟踪号" aria-describedby="mto-help"
                               placeholder="输入计划跟踪号..."
                               class="w-full bg-slate-800 border border-slate-700 text-slate-50 px-4 py-3 rounded focus:outline-none glow-emerald transition font-mono"
                               :disabled="loading"
                               autocomplete="off">
                        <p id="mto-help" class="sr-only">输入MTO跟踪号进行搜索，例如 AK2510034</p>

                        <!-- Search History Dropdown -->
                        <div x-show="showSearchHistory && searchHistory.length > 0" x-transition
                             class="search-history">
                            <div class="search-history-header">
                                <span class="text-xs text-slate-500">最近搜索</span>
                                <button @click.stop="clearSearchHistory()"
                                        class="text-xs text-slate-500 hover:text-slate-300 transition">
                                    清除
                                </button>
                            </div>
                            <template x-for="item in searchHistory" :key="item">
                                <button @mousedown.prevent="selectFromHistory(item)"
                                        class="search-history-item w-full text-left">
                                    <i data-lucide="clock" class="w-3 h-3 text-slate-500"></i>
                                    <span x-text="item"></span>
                                </button>
                            </template>
                        </div>

                        <div class="text-xs text-slate-600 mt-2">
                            提示: 按 <kbd class="px-1 bg-slate-800 rounded">/</kbd> 快速定位搜索框
                        </div>
                    </div>
                    <button @click="search()" :disabled="loading || !mtoNumber"
                            aria-label="搜索MTO单号"
                            class="px-6 py-3 bg-emerald-500 hover:bg-emerald-400 disabled:bg-slate-700 disabled:cursor-not-allowed text-slate-950 font-medium rounded transition flex items-center gap-2">
                        <span x-show="loading"
                              class="w-4 h-4 border-2 border-slate-950 border-t-transparent rounded-full animate-spin"></span>
                        <span x-text="loading ? '查询中...' : '查询'"></span>
                    </button>
                </div>
            </section>

            <div x-show="error" x-transition class="mb-6">
                <div class="p-4 bg-rose-500/10 border border-rose-500/30 rounded text-rose-400">
                    <span x-text="error"></span>
                </div>
            </div>
            <div x-show="successMessage" x-transition class="mb-6">
                <div class="p-4 bg-emerald-500/10 border border-emerald-500/30 rounded text-emerald-400">
                    <span x-text="successMessage"></span>
                </div>
            </div>

            <div x-show="parentItem" x-transition :class="isFullScreen && isCollapsed ? 'hidden' : 'mb-6'">
                <div class="bg-slate-900 border border-slate-800 rounded px-6 py-4">
                    <div class="flex items-center justify-between gap-6 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-slate-500">MTO</span>
                            <span class="text-slate-50 font-mono font-medium" x-text="parentItem?.mto_number"></span>
                        </div>
                        <div class="flex items-center gap-6">
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500">客户</span>
                                <span class="text-slate-200" x-text="parentItem?.customer_name || '-'"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500">交期</span>
                                <span class="text-slate-200" x-text="parentItem?.delivery_date ? parentItem.delivery_date.split('T')[0] : '-'"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500">数据</span>
                                <span class="px-2 py-0.5 rounded text-xs font-medium"
                                      :class="dataSource === 'cache' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-sky-500/20 text-sky-400'"
                                      x-text="dataSource === 'cache' ? ('缓存 · ' + formatCacheAge()) : '实时'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="childItems.length > 0" x-transition
                 class="bg-slate-900 border border-slate-800 rounded overflow-hidden">
                <div class="bg-slate-800 px-6 py-4 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-slate-50 flex items-center gap-2">
                        <i data-lucide="list" class="w-5 h-5"></i>
                        BOM组件明细
                        <span class="text-sm font-normal text-slate-400">
                            (<span x-text="getSortedItems().length"></span>/<span x-text="childItems.length"></span> 条)
                        </span>
                        <span x-show="hasActiveFilters()" class="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded">
                            已筛选
                        </span>
                    </h2>
                    <div class="flex items-center gap-3">
                        <button x-show="isFullScreen" @click="isCollapsed = !isCollapsed"
                                class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-sm transition">
                            <span x-text="isCollapsed ? '展开' : '收起'"></span>
                        </button>

                        <!-- Column Settings Dropdown -->
                        <div class="relative">
                            <button @click="showColumnSettings = !showColumnSettings"
                                    class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-sm transition flex items-center gap-2">
                                <i data-lucide="columns" class="w-4 h-4"></i>
                                列设置
                            </button>
                            <div x-show="showColumnSettings" @click.away="showColumnSettings = false" x-transition
                                 class="dropdown-menu column-settings">
                                <div class="dropdown-header">显示/隐藏列</div>
                                <template x-for="col in columns" :key="col.key">
                                    <label class="column-settings-item"
                                           :class="col.locked ? 'column-settings-item-locked' : ''">
                                        <input type="checkbox"
                                               :checked="col.visible"
                                               :disabled="col.locked"
                                               @change="toggleColumnVisibility(col.key)"
                                               class="column-settings-checkbox">
                                        <span class="text-sm text-slate-300" x-text="col.label"></span>
                                        <span x-show="col.locked" class="text-xs text-slate-500 ml-auto">锁定</span>
                                    </label>
                                </template>
                            </div>
                        </div>

                        <!-- Export Dropdown -->
                        <div class="relative">
                            <button @click="showExportMenu = !showExportMenu"
                                    class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-slate-950 text-sm font-medium transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                导出
                                <i data-lucide="chevron-down" class="w-3 h-3"></i>
                            </button>
                            <div x-show="showExportMenu" @click.away="showExportMenu = false" x-transition
                                 class="dropdown-menu" style="min-width: 160px;">
                                <button @click="exportToExcel('xlsx')"
                                        class="dropdown-item w-full text-left">
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                                    Excel (.xlsx)
                                </button>
                                <button @click="exportToExcel('csv')"
                                        class="dropdown-item w-full text-left">
                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                    CSV
                                </button>
                            </div>
                        </div>

                        <button @click="toggleFullScreen()"
                                class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-sm transition flex items-center gap-2">
                            <i :data-lucide="isFullScreen ? 'minimize-2' : 'maximize-2'" class="w-4 h-4"></i>
                            <span x-text="isFullScreen ? '退出全屏' : '全屏'"></span>
                        </button>
                    </div>
                </div>

                <!-- Filter Toolbar -->
                <div class="filter-toolbar">
                    <!-- Material Type Chips -->
                    <div class="filter-group">
                        <span class="filter-label">物料类型:</span>
                        <button @click="toggleMaterialType('成品')"
                                class="filter-chip"
                                :class="filters.materialTypes['成品'] ? 'filter-chip-active filter-chip-finished' : 'filter-chip-inactive'">
                            成品
                        </button>
                        <button @click="toggleMaterialType('自制')"
                                class="filter-chip"
                                :class="filters.materialTypes['自制'] ? 'filter-chip-active filter-chip-self-made' : 'filter-chip-inactive'">
                            自制
                        </button>
                        <button @click="toggleMaterialType('包材')"
                                class="filter-chip"
                                :class="filters.materialTypes['包材'] ? 'filter-chip-active filter-chip-purchased' : 'filter-chip-inactive'">
                            包材
                        </button>
                    </div>

                    <!-- Text Search -->
                    <div class="filter-search relative">
                        <i data-lucide="search" class="w-4 h-4 filter-search-icon"></i>
                        <input type="text" x-model.debounce.300ms="filters.searchText"
                               placeholder="搜索物料..."
                               class="pl-8">
                    </div>

                    <!-- Clear Filters -->
                    <button x-show="hasActiveFilters()" @click="resetFilters()"
                            class="text-sm text-slate-400 hover:text-slate-200 transition flex items-center gap-1">
                        <i data-lucide="x" class="w-3 h-3"></i>
                        清除筛选
                    </button>
                </div>

                <div class="overflow-x-auto overflow-y-auto bom-table" :class="isFullScreen ? 'max-h-[calc(100vh-180px)]' : 'max-h-[600px]'">
                    <table role="table" class="w-full text-sm" style="table-layout: fixed;">
                        <thead class="sticky top-0 z-10">
                            <tr role="row" class="border-b border-slate-700">
                                <!-- 序号 - not sortable, not resizable -->
                                <th scope="col" x-show="columns[0].visible"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sticky left-0 z-20"
                                    :style="getColumnStyle('index')">
                                    序号
                                </th>
                                <!-- 物料编码 - sortable -->
                                <th scope="col" x-show="columns[1].visible"
                                    @click="toggleSort('material_code')"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('material_code')">
                                    <div class="flex items-center gap-1">
                                        <span>物料编码</span>
                                        <i :data-lucide="getSortIcon('material_code')" class="w-3 h-3"
                                           :class="sort.column === 'material_code' ? 'text-emerald-400' : 'text-slate-600'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 1)"></div>
                                </th>
                                <!-- 物料名称 - sortable -->
                                <th scope="col" x-show="columns[2].visible"
                                    @click="toggleSort('material_name')"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('material_name')">
                                    <div class="flex items-center gap-1">
                                        <span>物料名称</span>
                                        <i :data-lucide="getSortIcon('material_name')" class="w-3 h-3"
                                           :class="sort.column === 'material_name' ? 'text-emerald-400' : 'text-slate-600'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 2)"></div>
                                </th>
                                <!-- 规格型号 - sortable -->
                                <th scope="col" x-show="columns[3].visible"
                                    @click="toggleSort('specification')"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('specification')">
                                    <div class="flex items-center gap-1">
                                        <span>规格型号</span>
                                        <i :data-lucide="getSortIcon('specification')" class="w-3 h-3"
                                           :class="sort.column === 'specification' ? 'text-emerald-400' : 'text-slate-600'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 3)"></div>
                                </th>
                                <!-- BOM简称 - sortable, only for 07.xx.xxx (成品) -->
                                <th scope="col" x-show="columns[4].visible"
                                    @click="toggleSort('bom_short_name')"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('bom_short_name')">
                                    <div class="flex items-center gap-1">
                                        <span>BOM简称</span>
                                        <i :data-lucide="getSortIcon('bom_short_name')" class="w-3 h-3"
                                           :class="sort.column === 'bom_short_name' ? 'text-emerald-400' : 'text-slate-600'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 4)"></div>
                                </th>
                                <!-- 辅助属性 - not sortable -->
                                <th scope="col" x-show="columns[5].visible"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap relative resizable"
                                    :style="getColumnStyle('aux_attributes')">
                                    辅助属性
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 5)"></div>
                                </th>
                                <!-- 物料类型 - sortable -->
                                <th scope="col" x-show="columns[6].visible"
                                    @click="toggleSort('material_type')"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('material_type')">
                                    <div class="flex items-center gap-1">
                                        <span>物料类型</span>
                                        <i :data-lucide="getSortIcon('material_type')" class="w-3 h-3"
                                           :class="sort.column === 'material_type' ? 'text-emerald-400' : 'text-slate-600'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 6)"></div>
                                </th>
                                <!-- 绿色组: 数量 (根据物料类型来源不同) -->
                                <th scope="col" x-show="columns[7].visible"
                                    @click="toggleSort('sales_order_qty')"
                                    class="px-4 py-3 text-right font-medium text-emerald-400 bg-slate-900 whitespace-nowrap border-l border-emerald-900 sortable-header relative resizable"
                                    :style="getColumnStyle('sales_order_qty')">
                                    <div class="flex items-center justify-end gap-1">
                                        <span>销售订单.数量</span>
                                        <i :data-lucide="getSortIcon('sales_order_qty')" class="w-3 h-3"
                                           :class="sort.column === 'sales_order_qty' ? 'text-emerald-400' : 'text-slate-600'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 7)"></div>
                                </th>
                                <th scope="col" x-show="columns[8].visible"
                                    @click="toggleSort('prod_instock_must_qty')"
                                    class="px-4 py-3 text-right font-medium text-emerald-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('prod_instock_must_qty')">
                                    <div class="flex items-center justify-end gap-1">
                                        <span>生产入库单.应收数量</span>
                                        <i :data-lucide="getSortIcon('prod_instock_must_qty')" class="w-3 h-3"
                                           :class="sort.column === 'prod_instock_must_qty' ? 'text-emerald-400' : 'text-slate-600'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 8)"></div>
                                </th>
                                <th scope="col" x-show="columns[9].visible"
                                    @click="toggleSort('purchase_order_qty')"
                                    class="px-4 py-3 text-right font-medium text-emerald-400 bg-slate-900 whitespace-nowrap border-r border-emerald-900 sortable-header relative resizable"
                                    :style="getColumnStyle('purchase_order_qty')">
                                    <div class="flex items-center justify-end gap-1">
                                        <span>采购订单.数量</span>
                                        <i :data-lucide="getSortIcon('purchase_order_qty')" class="w-3 h-3"
                                           :class="sort.column === 'purchase_order_qty' ? 'text-emerald-400' : 'text-slate-600'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 9)"></div>
                                </th>
                                <!-- 领料/入库列 -->
                                <th scope="col" x-show="columns[10].visible"
                                    @click="toggleSort('pick_actual_qty')"
                                    class="px-4 py-3 text-right font-medium text-slate-400 bg-slate-900 whitespace-nowrap border-l border-sky-900 sortable-header relative resizable"
                                    :style="getColumnStyle('pick_actual_qty')">
                                    <div class="flex items-center justify-end gap-1">
                                        <span>生产领料单.实发数量</span>
                                        <i :data-lucide="getSortIcon('pick_actual_qty')" class="w-3 h-3"
                                           :class="sort.column === 'pick_actual_qty' ? 'text-emerald-400' : 'text-slate-600'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 10)"></div>
                                </th>
                                <th scope="col" x-show="columns[11].visible"
                                    @click="toggleSort('prod_instock_real_qty')"
                                    class="px-4 py-3 text-right font-medium text-sky-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('prod_instock_real_qty')">
                                    <div class="flex items-center justify-end gap-1">
                                        <span>生产入库单.实收数量</span>
                                        <i :data-lucide="getSortIcon('prod_instock_real_qty')" class="w-3 h-3"
                                           :class="sort.column === 'prod_instock_real_qty' ? 'text-emerald-400' : 'text-slate-600'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 11)"></div>
                                </th>
                                <th scope="col" x-show="columns[12].visible"
                                    @click="toggleSort('purchase_stock_in_qty')"
                                    class="px-4 py-3 text-right font-medium text-sky-400 bg-slate-900 whitespace-nowrap border-r border-sky-900 sortable-header relative resizable"
                                    :style="getColumnStyle('purchase_stock_in_qty')">
                                    <div class="flex items-center justify-end gap-1">
                                        <span>采购订单.累计入库数量</span>
                                        <i :data-lucide="getSortIcon('purchase_stock_in_qty')" class="w-3 h-3"
                                           :class="sort.column === 'purchase_stock_in_qty' ? 'text-emerald-400' : 'text-slate-600'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 12)"></div>
                                </th>
                            </tr>
                        </thead>
                        <tbody role="rowgroup">
                            <template x-for="(item, index) in getSortedItems()" :key="item.material_code + '-' + index">
                                <tr role="row" class="border-b border-slate-800 hover:bg-slate-800/50 transition">
                                    <td x-show="columns[0].visible" role="cell" class="px-4 py-3 text-slate-500 bg-slate-900 sticky left-0 z-[5]" x-text="index + 1"></td>
                                    <td x-show="columns[1].visible" role="cell" class="px-4 py-3 font-mono text-sm text-slate-300" x-text="item.material_code"></td>
                                    <td x-show="columns[2].visible" role="cell" class="px-4 py-3 text-slate-200" x-text="item.material_name"></td>
                                    <td x-show="columns[3].visible" role="cell" class="px-4 py-3 text-slate-400" x-text="item.specification || '-'"></td>
                                    <!-- BOM简称 - only for 07.xx.xxx (成品) -->
                                    <td x-show="columns[4].visible" role="cell" class="px-4 py-3 text-slate-400"
                                        x-text="item.material_code?.startsWith('07') ? (item.bom_short_name || '-') : '-'"></td>
                                    <td x-show="columns[5].visible" role="cell" class="px-4 py-3 text-slate-400 text-xs max-w-[200px] truncate"
                                        :title="item.aux_attributes || ''"
                                        x-text="item.aux_attributes || '-'"></td>
                                    <td x-show="columns[6].visible" role="cell" class="px-4 py-3">
                                        <span class="px-2 py-1 rounded text-xs font-medium"
                                              :class="getMaterialTypeBadge(item.material_type)"
                                              x-text="item.material_type"></span>
                                    </td>
                                    <!-- 绿色组: 数量列 (根据物料类型显示) -->
                                    <td x-show="columns[7].visible" role="cell"
                                        class="px-4 py-3 text-right font-medium text-slate-200 bg-emerald-950/10"
                                        x-text="item.material_code?.startsWith('07') ? formatNumber(item.sales_order_qty) : '-'"></td>
                                    <td x-show="columns[8].visible" role="cell" class="px-4 py-3 text-right font-medium text-slate-200 bg-emerald-950/10"
                                        x-text="item.material_code?.startsWith('05') ? formatNumber(item.prod_instock_must_qty) : '-'"></td>
                                    <td x-show="columns[9].visible" role="cell" class="px-4 py-3 text-right font-medium text-slate-200 bg-emerald-950/10"
                                        x-text="item.material_code?.startsWith('03') ? formatNumber(item.purchase_order_qty) : '-'"></td>
                                    <!-- 领料/入库列 -->
                                    <td x-show="columns[10].visible" role="cell" class="px-4 py-3 text-right text-slate-300 bg-sky-950/10"
                                        x-text="['03', '05'].some(p => item.material_code?.startsWith(p)) ? formatNumber(item.pick_actual_qty) : '-'"></td>
                                    <td x-show="columns[11].visible" role="cell" class="px-4 py-3 text-right text-slate-300 bg-sky-950/10"
                                        x-text="['05', '07'].some(p => item.material_code?.startsWith(p)) ? formatNumber(item.prod_instock_real_qty) : '-'"></td>
                                    <td x-show="columns[12].visible" role="cell" class="px-4 py-3 text-right text-slate-300 bg-sky-950/10"
                                        x-text="item.material_code?.startsWith('03') ? formatNumber(item.purchase_stock_in_qty) : '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                        <tfoot class="sticky bottom-0 z-10" x-data="{ totals: calculateTotals() }" x-effect="totals = calculateTotals()">
                            <tr class="border-t-2 border-slate-600 bg-slate-800 font-semibold">
                                <td x-show="columns[0].visible" class="px-4 py-3 text-slate-400 bg-slate-800 sticky left-0 z-20">合计</td>
                                <td x-show="columns[1].visible" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <td x-show="columns[2].visible" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <td x-show="columns[3].visible" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <td x-show="columns[4].visible" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <td x-show="columns[5].visible" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <td x-show="columns[6].visible" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <!-- 绿色组合计 -->
                                <td x-show="columns[7].visible" class="px-4 py-3 text-right text-emerald-400 bg-slate-800"
                                    x-text="formatNumber(totals.sales_order_qty)"></td>
                                <td x-show="columns[8].visible" class="px-4 py-3 text-right text-emerald-400 bg-slate-800"
                                    x-text="formatNumber(totals.prod_instock_must_qty)"></td>
                                <td x-show="columns[9].visible" class="px-4 py-3 text-right text-emerald-400 bg-slate-800"
                                    x-text="formatNumber(totals.purchase_order_qty)"></td>
                                <!-- 领料/入库合计 -->
                                <td x-show="columns[10].visible" class="px-4 py-3 text-right text-sky-400 bg-slate-800"
                                    x-text="formatNumber(totals.pick_actual_qty)"></td>
                                <td x-show="columns[11].visible" class="px-4 py-3 text-right text-sky-400 bg-slate-800"
                                    x-text="formatNumber(totals.prod_instock_real_qty)"></td>
                                <td x-show="columns[12].visible" class="px-4 py-3 text-right text-sky-400 bg-slate-800"
                                    x-text="formatNumber(totals.purchase_stock_in_qty)"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="bom-cards md:hidden">
                    <template x-for="(item, index) in getSortedItems()" :key="`card-${item.material_code}-${index}`">
                        <div class="bom-card">
                            <div class="bom-card-header">
                                <div>
                                    <div class="font-mono text-sm text-slate-300" x-text="item.material_code"></div>
                                    <div class="text-slate-200 mt-1" x-text="item.material_name"></div>
                                    <div class="text-slate-500 text-xs mt-1" x-show="item.aux_attributes" x-text="item.aux_attributes"></div>
                                </div>
                                <span class="px-2 py-1 rounded text-xs font-medium"
                                      :class="getMaterialTypeBadge(item.material_type)"
                                      x-text="item.material_type"></span>
                            </div>
                            <div class="bom-card-grid">
                                <!-- 数量列：根据物料类型显示 -->
                                <div class="bom-card-item" x-show="item.material_code?.startsWith('07')">
                                    <span class="bom-card-label">销售订单.数量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.sales_order_qty)"></span>
                                </div>
                                <div class="bom-card-item" x-show="item.material_code?.startsWith('05')">
                                    <span class="bom-card-label">生产入库单.应收数量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.prod_instock_must_qty)"></span>
                                </div>
                                <div class="bom-card-item" x-show="item.material_code?.startsWith('03')">
                                    <span class="bom-card-label">采购订单.数量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.purchase_order_qty)"></span>
                                </div>
                                <!-- 领料/入库列 -->
                                <div class="bom-card-item" x-show="['03', '05'].some(p => item.material_code?.startsWith(p))">
                                    <span class="bom-card-label">生产领料单.实发数量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.pick_actual_qty)"></span>
                                </div>
                                <div class="bom-card-item" x-show="['05', '07'].some(p => item.material_code?.startsWith(p))">
                                    <span class="bom-card-label">生产入库单.实收数量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.prod_instock_real_qty)"></span>
                                </div>
                                <div class="bom-card-item" x-show="item.material_code?.startsWith('03')">
                                    <span class="bom-card-label">采购订单.累计入库数量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.purchase_stock_in_qty)"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="bg-slate-800/50 px-6 py-4 border-t border-slate-700">
                    <div class="flex items-center justify-between text-sm">
                        <div class="text-slate-400">
                            显示 <span class="font-bold text-slate-200" x-text="getSortedItems().length"></span> / <span x-text="childItems.length"></span> 条记录
                            <span x-show="hasActiveFilters()" class="ml-2 text-emerald-400">(已筛选)</span>
                        </div>
                        <div class="flex items-center gap-6 text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-violet-500 rounded"></div>
                                <span class="text-slate-400">成品 (07.xx)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-emerald-500 rounded"></div>
                                <span class="text-slate-400">自制 (05.xx)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-sky-500 rounded"></div>
                                <span class="text-slate-400">包材 (03.xx)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="childItems.length > 0" x-transition
                 class="mt-6 bg-slate-900 border border-slate-800 rounded overflow-hidden">
                <div class="bg-slate-800 px-6 py-4 flex items-center justify-between cursor-pointer"
                     @click="relatedOrdersExpanded = !relatedOrdersExpanded">
                    <h2 class="text-lg font-semibold text-slate-50 flex items-center gap-2">
                        <i data-lucide="share-2" class="w-5 h-5"></i>
                        订单关联图
                    </h2>
                    <div class="flex items-center gap-2 text-sm text-slate-400">
                        <span x-text="relatedOrdersExpanded ? '收起' : '展开'"></span>
                        <i :data-lucide="relatedOrdersExpanded ? 'chevron-up' : 'chevron-down'" class="w-4 h-4"></i>
                    </div>
                </div>

                <div x-show="relatedOrdersExpanded" class="p-6 space-y-4">
                    <div x-show="relatedOrdersLoading" class="text-slate-400 text-sm">
                        正在加载关联单据...
                    </div>
                    <div x-show="relatedOrdersError" class="text-rose-400 text-sm" x-text="relatedOrdersError"></div>

                    <template x-if="!relatedOrdersLoading && hasRelatedOrders()">
                        <div class="tree-container">
                            <div class="tree-node tree-root">
                                <span class="tree-label">MTO号</span>
                                <span class="tree-value" x-text="mtoNumber"></span>
                            </div>
                            <div class="tree-children">
                                <div class="space-y-3">
                                    <template x-for="order in relatedOrders.orders.sales_orders" :key="`so-${order.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-sales">
                                                <span class="tree-label" x-text="order.label"></span>
                                                <span class="tree-value" x-text="order.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="doc in relatedOrders.documents.sales_deliveries" :key="`sd-${doc.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-sales tree-doc">
                                                <span class="tree-label" x-text="doc.label"></span>
                                                <span class="tree-value" x-text="doc.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <div class="space-y-3">
                                    <template x-for="order in relatedOrders.orders.production_orders" :key="`po-${order.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-production">
                                                <span class="tree-label" x-text="order.label"></span>
                                                <span class="tree-value" x-text="order.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="doc in relatedOrders.documents.production_receipts" :key="`pr-${doc.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-production tree-doc">
                                                <span class="tree-label" x-text="doc.label"></span>
                                                <span class="tree-value" x-text="doc.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="doc in relatedOrders.documents.material_pickings" :key="`mp-${doc.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-production tree-doc">
                                                <span class="tree-label" x-text="doc.label"></span>
                                                <span class="tree-value" x-text="doc.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <div class="space-y-3">
                                    <template x-for="order in relatedOrders.orders.purchase_orders" :key="`pu-${order.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-purchase">
                                                <span class="tree-label" x-text="order.label"></span>
                                                <span class="tree-value" x-text="order.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="doc in relatedOrders.documents.purchase_receipts" :key="`prc-${doc.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-purchase tree-doc">
                                                <span class="tree-label" x-text="doc.label"></span>
                                                <span class="tree-value" x-text="doc.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="!relatedOrdersLoading && !relatedOrdersError && !hasRelatedOrders()" class="text-slate-500 text-sm">
                        暂无关联单据
                    </div>
                </div>
            </div>

            <div x-show="loading" class="bg-slate-900 border border-slate-800 rounded p-6">
                <div class="space-y-4">
                    <template x-for="i in 5" :key="i">
                        <div class="flex gap-4">
                            <div class="skeleton h-4 w-12 rounded"></div>
                            <div class="skeleton h-4 w-32 rounded"></div>
                            <div class="skeleton h-4 flex-1 rounded"></div>
                            <div class="skeleton h-4 w-20 rounded"></div>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="!loading && childItems.length === 0 && !error" class="text-center py-20">
                <i data-lucide="inbox" class="w-16 h-16 text-slate-700 mx-auto mb-4"></i>
                <h3 class="text-lg text-slate-400 mb-2">暂无数据</h3>
                <p class="text-slate-600 text-sm">请输入MTO单号进行查询</p>
            </div>
        </main>

        <div class="fixed bottom-4 right-4 text-xs text-slate-600 no-print" x-show="childItems.length > 0">
            <span class="px-2 py-1 bg-slate-800 rounded mr-1">F11</span> 全屏
            <span class="px-2 py-1 bg-slate-800 rounded mr-1 ml-2">ESC</span> 退出
        </div>

        <div aria-live="polite" aria-atomic="true" class="sr-only"
             x-text="loading ? '正在加载...' : (error ? '发生错误: ' + error : (parentItem ? '已加载MTO单号 ' + mtoNumber + ' 的数据' : ''))">
        </div>
    </div>

    <script src="/static/js/api.js?v=20260202b"></script>
    <script src="/static/js/auth.js?v=20260202b"></script>
    <script src="/static/js/dashboard.js?v=20260202b"></script>
    <script>
        // Initialize Lucide icons once on page load
        lucide.createIcons();

        // Debounced icon refresh for dynamic content
        let iconRefreshTimeout = null;
        function refreshIcons() {
            if (iconRefreshTimeout) clearTimeout(iconRefreshTimeout);
            iconRefreshTimeout = setTimeout(() => {
                lucide.createIcons();
            }, 100);
        }

        // Only refresh icons after Alpine finishes major updates
        document.addEventListener('alpine:initialized', () => {
            // Refresh icons once after Alpine initializes
            refreshIcons();
        });
    </script>
</body>
</html>
