<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickPulse V2 - 产品状态明细表</title>

    <!-- Use system fonts for reliability in China (no Google Fonts dependency) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 950: '#0a0a0b' } },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', 'Hiragino Sans GB', 'sans-serif'],
                        mono: ['SFMono-Regular', 'Consolas', 'Liberation Mono', 'monospace']
                    }
                }
            }
        };
    </script>

    <!-- Serve Alpine.js locally for reliability in China -->
    <script defer src="/static/js/alpine.min.js"></script>
    <script src="/static/js/lucide.min.js"></script>
    <!-- SheetJS for Excel export (served locally for China reliability) -->
    <script src="/static/js/xlsx.full.min.js"></script>

    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body class="bg-slate-950 min-h-screen" x-data="authGuard()">
    <a href="#main-content"
       class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:bg-slate-900 focus:text-slate-50 focus:px-4 focus:py-2 focus:rounded">
        跳转到主要内容
    </a>

    <div x-data="mtoSearch()" x-init="init()" x-cloak @keydown.escape.window="chatOpen ? (chatOpen = false) : exitFullScreen()">
        <div class="chat-content-push" :style="chatOpen ? 'margin-right: 384px' : ''" >
        <header class="bg-slate-900 border-b border-slate-800 px-6 py-4 no-print"
                :class="isFullScreen && isCollapsed ? 'hidden' : ''">
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-semibold text-slate-50 tracking-wide">QuickPulse</h1>
                    <span class="text-slate-600 text-sm">|</span>
                    <span class="text-slate-400 text-sm">产品状态明细表</span>
                </div>
                <div class="flex items-center gap-6">
                    <span class="text-slate-400 text-sm font-mono" x-text="new Date().toLocaleString('zh-CN')"></span>
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open"
                                class="flex items-center gap-2 text-slate-400 hover:text-slate-50 transition">
                            <i data-lucide="user" class="w-4 h-4"></i>
                            <span class="text-sm">用户</span>
                            <i data-lucide="chevron-down" class="w-3 h-3"></i>
                        </button>
                        <div x-show="open" @click.away="open = false" x-transition
                             class="absolute right-0 mt-2 w-40 bg-slate-800 border border-slate-700 rounded shadow-lg py-1 z-50">
                            <a href="/sync.html" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700">同步管理</a>
                            <button @click="api.logout()"
                                    class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-700">
                                退出登录
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="max-w-7xl mx-auto px-6 py-8" :class="isFullScreen ? 'max-w-full' : ''">
            <section :class="isFullScreen && isCollapsed ? 'hidden' : 'mb-8'" class="transition-all">
                <div class="flex gap-4 items-end">
                    <div class="flex-1 max-w-md relative">
                        <label for="mto-search" class="block text-sm text-slate-400 mb-2">MTO单号</label>
                        <input type="text" id="mto-search" x-model="mtoNumber"
                               @keydown.enter="showSearchResults = false; search()"
                               @input="performSearch()"
                               @focus="if (!mtoNumber.trim() || mtoNumber.trim().length < 2) { showSearchHistory = searchHistory.length > 0; showSearchResults = false; }"
                               @blur="setTimeout(() => { showSearchHistory = false; showSearchResults = false; }, 200)"
                               aria-label="计划跟踪号" aria-describedby="mto-help"
                               placeholder="输入计划跟踪号..."
                               class="w-full bg-slate-800 border border-slate-700 text-slate-50 px-4 py-3 rounded focus:outline-none glow-emerald transition font-mono"
                               :disabled="loading"
                               autocomplete="off">
                        <p id="mto-help" class="sr-only">输入MTO跟踪号进行搜索，例如 AK2510034</p>

                        <!-- Search History Dropdown -->
                        <div x-show="showSearchHistory && searchHistory.length > 0 && !showSearchResults" x-transition
                             class="search-history">
                            <div class="search-history-header">
                                <span class="text-xs text-slate-500">最近搜索</span>
                                <button @click.stop="clearSearchHistory()"
                                        class="text-xs text-slate-500 hover:text-slate-300 transition">
                                    清除
                                </button>
                            </div>
                            <template x-for="item in searchHistory" :key="item">
                                <button @mousedown.prevent="selectFromHistory(item)"
                                        class="search-history-item w-full text-left">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    <span x-text="item"></span>
                                </button>
                            </template>
                        </div>

                        <!-- Search Results Dropdown -->
                        <div x-show="showSearchResults && searchResults.length > 0 && !showSearchHistory"
                             x-transition
                             class="absolute left-0 right-0 top-full mt-1 bg-slate-800 border border-slate-700 rounded shadow-lg z-50 max-h-80 overflow-y-auto">
                            <div class="px-3 py-2 border-b border-slate-700 flex items-center justify-between">
                                <span class="text-xs text-slate-500">搜索结果</span>
                                <span x-show="searchLoading" class="w-3 h-3 border border-slate-400 border-t-transparent rounded-full animate-spin inline-block"></span>
                            </div>
                            <template x-for="result in searchResults" :key="result.mto_number">
                                <button @mousedown.prevent="selectSearchResult(result.mto_number)"
                                        class="w-full text-left px-3 py-2 hover:bg-slate-700 transition flex items-center gap-3 border-b border-slate-700/50 last:border-b-0">
                                    <span class="font-mono text-sm font-medium text-slate-200" x-text="result.mto_number"></span>
                                    <span class="text-xs text-slate-400 truncate flex-1" x-text="result.material_name || ''"></span>
                                    <span x-show="result.order_qty" class="text-xs text-slate-500 whitespace-nowrap" x-text="'x' + result.order_qty"></span>
                                </button>
                            </template>
                            <div x-show="searchTotal > searchResults.length" class="px-3 py-2 border-t border-slate-700 text-center">
                                <span class="text-xs text-slate-500" x-text="'共 ' + searchTotal + ' 条结果'"></span>
                            </div>
                        </div>

                        <!-- No search results state -->
                        <div x-show="showSearchResults && searchResults.length === 0 && !searchLoading" x-transition
                             class="absolute left-0 right-0 top-full mt-1 bg-slate-800 border border-slate-700 rounded shadow-lg z-50 px-3 py-4 text-center">
                            <span class="text-sm text-slate-500">未找到相关结果</span>
                        </div>

                        <div class="text-xs text-slate-600 mt-2">
                            提示: 按 <kbd class="px-1 bg-slate-800 rounded">/</kbd> 快速定位搜索框
                        </div>
                    </div>
                    <button @click="search()" :disabled="loading || !mtoNumber"
                            aria-label="搜索MTO单号"
                            class="px-6 py-3 bg-emerald-500 hover:bg-emerald-400 disabled:bg-slate-700 disabled:cursor-not-allowed text-slate-950 font-medium rounded transition flex items-center gap-2">
                        <span x-show="loading"
                              class="w-4 h-4 border-2 border-slate-950 border-t-transparent rounded-full animate-spin"></span>
                        <span x-text="loading ? '查询中...' : '查询'"></span>
                    </button>
                </div>
            </section>

            <div x-show="error" x-transition class="mb-6">
                <div class="p-4 bg-rose-500/10 border border-rose-500/30 rounded text-rose-400">
                    <span x-text="error"></span>
                </div>
            </div>
            <div x-show="successMessage" x-transition class="mb-6">
                <div class="p-4 bg-emerald-500/10 border border-emerald-500/30 rounded text-emerald-400">
                    <span x-text="successMessage"></span>
                </div>
            </div>

            <div x-show="parentItem" x-transition :class="isFullScreen && isCollapsed ? 'hidden' : 'mb-6'">
                <div class="bg-slate-900 border border-slate-800 rounded px-6 py-4">
                    <div class="flex items-center justify-between gap-6 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-slate-500">MTO</span>
                            <span class="text-slate-50 font-mono font-medium" x-text="parentItem?.mto_number"></span>
                        </div>
                        <div class="flex items-center gap-6">
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500">客户</span>
                                <span class="text-slate-200" x-text="parentItem?.customer_name || '-'"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500">交期</span>
                                <span class="text-slate-200" x-text="parentItem?.delivery_date ? parentItem.delivery_date.split('T')[0] : '-'"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500">数据</span>
                                <span class="px-2 py-0.5 rounded text-xs font-medium"
                                      :class="dataSource === 'cache' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-sky-500/20 text-sky-400'"
                                      x-text="dataSource === 'cache' ? ('缓存 · ' + formatCacheAge()) : '实时'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="childItems.length > 0" x-transition
                 class="bg-slate-900 border border-slate-800 rounded overflow-hidden">
                <div class="bg-slate-800 px-6 py-4 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-slate-50 flex items-center gap-2">
                        <i data-lucide="list" class="w-5 h-5"></i>
                        BOM组件明细
                        <span class="text-sm font-normal text-slate-400">
                            (<span x-text="getSortedItems().length"></span>/<span x-text="childItems.length"></span> 条)
                        </span>
                        <span x-show="hasActiveFilters()" class="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded">
                            已筛选
                        </span>
                    </h2>
                    <div class="flex items-center gap-3">
                        <button x-show="isFullScreen" @click="isCollapsed = !isCollapsed"
                                class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-sm transition">
                            <span x-text="isCollapsed ? '展开' : '收起'"></span>
                        </button>

                        <!-- Column Settings Dropdown -->
                        <div class="relative">
                            <button @click="showColumnSettings = !showColumnSettings"
                                    aria-label="Column settings"
                                    class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-sm transition flex items-center gap-2">
                                <i data-lucide="columns" class="w-4 h-4"></i>
                                列设置
                            </button>
                            <div x-show="showColumnSettings" @click.away="showColumnSettings = false" x-transition
                                 class="dropdown-menu column-settings">
                                <div class="dropdown-header">显示/隐藏列</div>
                                <template x-for="col in columns" :key="col.key">
                                    <label class="column-settings-item"
                                           :class="col.locked ? 'column-settings-item-locked' : ''">
                                        <input type="checkbox"
                                               :checked="col.visible"
                                               :disabled="col.locked"
                                               @change="toggleColumnVisibility(col.key)"
                                               class="column-settings-checkbox">
                                        <span class="text-sm text-slate-300" x-text="col.label"></span>
                                        <span x-show="col.locked" class="text-xs text-slate-500 ml-auto">锁定</span>
                                    </label>
                                </template>
                            </div>
                        </div>

                        <!-- Export Dropdown -->
                        <div class="relative">
                            <button @click="showExportMenu = !showExportMenu"
                                    aria-label="Export options"
                                    class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-slate-950 text-sm font-medium transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                导出
                                <i data-lucide="chevron-down" class="w-3 h-3"></i>
                            </button>
                            <div x-show="showExportMenu" @click.away="showExportMenu = false" x-transition
                                 class="dropdown-menu" style="min-width: 160px;">
                                <button @click="exportToExcel('xlsx')"
                                        class="dropdown-item w-full text-left">
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                                    Excel (.xlsx)
                                </button>
                                <button @click="exportToExcel('csv')"
                                        class="dropdown-item w-full text-left">
                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                    CSV
                                </button>
                            </div>
                        </div>

                        <button @click="toggleFullScreen()"
                                class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-sm transition flex items-center gap-2">
                            <i data-lucide="maximize-2" class="w-4 h-4" x-show="!isFullScreen"></i>
                            <i data-lucide="minimize-2" class="w-4 h-4" x-show="isFullScreen"></i>
                            <span x-text="isFullScreen ? '退出全屏' : '全屏'"></span>
                        </button>
                    </div>
                </div>

                <!-- Filter Toolbar -->
                <div class="filter-toolbar">
                    <!-- Material Type Chips -->
                    <div class="filter-group">
                        <span class="filter-label">物料类型:</span>
                        <button @click="toggleMaterialType('成品')"
                                class="filter-chip"
                                :class="filters.materialTypes['成品'] ? 'filter-chip-active filter-chip-finished' : 'filter-chip-inactive'">
                            成品
                        </button>
                        <button @click="toggleMaterialType('自制')"
                                class="filter-chip"
                                :class="filters.materialTypes['自制'] ? 'filter-chip-active filter-chip-self-made' : 'filter-chip-inactive'">
                            自制
                        </button>
                        <button @click="toggleMaterialType('包材')"
                                class="filter-chip"
                                :class="filters.materialTypes['包材'] ? 'filter-chip-active filter-chip-purchased' : 'filter-chip-inactive'">
                            包材
                        </button>
                    </div>

                    <!-- Status Filter -->
                    <div class="filter-group">
                        <span class="filter-label">状态:</span>
                        <button @click="setStatusFilter('all')"
                                class="filter-chip"
                                :class="filters.status === 'all' ? 'filter-chip-active bg-slate-600 text-slate-200' : 'filter-chip-inactive'">
                            全部
                        </button>
                        <button @click="setStatusFilter('completed')"
                                class="filter-chip"
                                :class="filters.status === 'completed' ? 'filter-chip-active bg-emerald-900/60 text-emerald-300 border-emerald-700' : 'filter-chip-inactive'">
                            已完成
                        </button>
                        <button @click="setStatusFilter('in_progress')"
                                class="filter-chip"
                                :class="filters.status === 'in_progress' ? 'filter-chip-active bg-amber-900/60 text-amber-300 border-amber-700' : 'filter-chip-inactive'">
                            进行中
                        </button>
                        <button @click="setStatusFilter('not_started')"
                                class="filter-chip"
                                :class="filters.status === 'not_started' ? 'filter-chip-active bg-slate-700 text-slate-300 border-slate-600' : 'filter-chip-inactive'">
                            未开始
                        </button>
                    </div>

                    <!-- Text Search -->
                    <div class="filter-search relative">
                        <i data-lucide="search" class="w-4 h-4 filter-search-icon"></i>
                        <input type="text" x-model.debounce.300ms="filters.searchText"
                               placeholder="搜索物料..."
                               class="pl-8">
                    </div>

                    <!-- Clear Filters -->
                    <button x-show="hasActiveFilters()" @click="resetFilters()"
                            class="text-sm text-slate-400 hover:text-slate-200 transition flex items-center gap-1">
                        <i data-lucide="x" class="w-3 h-3"></i>
                        清除筛选
                    </button>
                </div>

                <div class="overflow-x-auto overflow-y-auto bom-table" :class="isFullScreen ? 'max-h-[calc(100vh-180px)]' : 'max-h-[600px]'">
                    <table role="table" class="w-full text-sm">
                        <thead class="sticky top-0 z-10">
                            <tr role="row" class="border-b border-slate-700">
                                <!-- 序号 - not sortable, not resizable -->
                                <th scope="col" :class="{ 'col-hidden': !colVisible('index') }"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sticky left-0 z-20"
                                    :style="getColumnStyle('index')">
                                    序号
                                </th>
                                <!-- 物料编码 - sortable -->
                                <th scope="col" :class="{ 'col-hidden': !colVisible('material_code') }"
                                    @click="toggleSort('material_code')"
                                    :aria-sort="sort.column === 'material_code' ? (sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('material_code')">
                                    <div class="flex items-center gap-1">
                                        <span>物料编码</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-600" x-show="sort.column !== 'material_code'"></i>
                                        <i data-lucide="arrow-up" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'material_code' && sort.direction === 'asc'"></i>
                                        <i data-lucide="arrow-down" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'material_code' && sort.direction === 'desc'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'material_code')"></div>
                                </th>
                                <!-- 物料名称 - sortable -->
                                <th scope="col" :class="{ 'col-hidden': !colVisible('material_name') }"
                                    @click="toggleSort('material_name')"
                                    :aria-sort="sort.column === 'material_name' ? (sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('material_name')">
                                    <div class="flex items-center gap-1">
                                        <span>物料名称</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-600" x-show="sort.column !== 'material_name'"></i>
                                        <i data-lucide="arrow-up" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'material_name' && sort.direction === 'asc'"></i>
                                        <i data-lucide="arrow-down" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'material_name' && sort.direction === 'desc'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'material_name')"></div>
                                </th>
                                <!-- 规格型号 - sortable -->
                                <th scope="col" :class="{ 'col-hidden': !colVisible('specification') }"
                                    @click="toggleSort('specification')"
                                    :aria-sort="sort.column === 'specification' ? (sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('specification')">
                                    <div class="flex items-center gap-1">
                                        <span>规格型号</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-600" x-show="sort.column !== 'specification'"></i>
                                        <i data-lucide="arrow-up" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'specification' && sort.direction === 'asc'"></i>
                                        <i data-lucide="arrow-down" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'specification' && sort.direction === 'desc'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'specification')"></div>
                                </th>
                                <!-- BOM简称 - sortable, only for 07.xx.xxx (成品) -->
                                <th scope="col" :class="{ 'col-hidden': !colVisible('bom_short_name') }"
                                    @click="toggleSort('bom_short_name')"
                                    :aria-sort="sort.column === 'bom_short_name' ? (sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('bom_short_name')">
                                    <div class="flex items-center gap-1">
                                        <span>BOM简称</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-600" x-show="sort.column !== 'bom_short_name'"></i>
                                        <i data-lucide="arrow-up" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'bom_short_name' && sort.direction === 'asc'"></i>
                                        <i data-lucide="arrow-down" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'bom_short_name' && sort.direction === 'desc'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'bom_short_name')"></div>
                                </th>
                                <!-- 辅助属性 - not sortable -->
                                <th scope="col" :class="{ 'col-hidden': !colVisible('aux_attributes') }"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap relative resizable"
                                    :style="getColumnStyle('aux_attributes')">
                                    辅助属性
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'aux_attributes')"></div>
                                </th>
                                <!-- 物料类型 - sortable -->
                                <th scope="col" :class="{ 'col-hidden': !colVisible('material_type') }"
                                    @click="toggleSort('material_type')"
                                    :aria-sort="sort.column === 'material_type' ? (sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
                                    class="px-4 py-3 text-left font-medium text-slate-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('material_type')">
                                    <div class="flex items-center gap-1">
                                        <span>物料类型</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-600" x-show="sort.column !== 'material_type'"></i>
                                        <i data-lucide="arrow-up" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'material_type' && sort.direction === 'asc'"></i>
                                        <i data-lucide="arrow-down" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'material_type' && sort.direction === 'desc'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'material_type')"></div>
                                </th>
                                <!-- 绿色组: 数量 (根据物料类型来源不同) -->
                                <th scope="col" :class="{ 'col-hidden': !colVisible('sales_order_qty') }"
                                    @click="toggleSort('sales_order_qty')"
                                    :aria-sort="sort.column === 'sales_order_qty' ? (sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
                                    class="px-4 py-3 text-right font-medium text-emerald-400 bg-slate-900 whitespace-nowrap border-l border-emerald-900 sortable-header relative resizable"
                                    :style="getColumnStyle('sales_order_qty')">
                                    <div class="flex items-center justify-end gap-1">
                                        <span>销售订单.数量</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-600" x-show="sort.column !== 'sales_order_qty'"></i>
                                        <i data-lucide="arrow-up" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'sales_order_qty' && sort.direction === 'asc'"></i>
                                        <i data-lucide="arrow-down" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'sales_order_qty' && sort.direction === 'desc'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'sales_order_qty')"></div>
                                </th>
                                <th scope="col" :class="{ 'col-hidden': !colVisible('prod_instock_must_qty') }"
                                    @click="toggleSort('prod_instock_must_qty')"
                                    :aria-sort="sort.column === 'prod_instock_must_qty' ? (sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
                                    class="px-4 py-3 text-right font-medium text-emerald-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('prod_instock_must_qty')">
                                    <div class="flex items-center justify-end gap-1">
                                        <span>生产入库单.应收数量</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-600" x-show="sort.column !== 'prod_instock_must_qty'"></i>
                                        <i data-lucide="arrow-up" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'prod_instock_must_qty' && sort.direction === 'asc'"></i>
                                        <i data-lucide="arrow-down" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'prod_instock_must_qty' && sort.direction === 'desc'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'prod_instock_must_qty')"></div>
                                </th>
                                <th scope="col" :class="{ 'col-hidden': !colVisible('purchase_order_qty') }"
                                    @click="toggleSort('purchase_order_qty')"
                                    :aria-sort="sort.column === 'purchase_order_qty' ? (sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
                                    class="px-4 py-3 text-right font-medium text-emerald-400 bg-slate-900 whitespace-nowrap border-r border-emerald-900 sortable-header relative resizable"
                                    :style="getColumnStyle('purchase_order_qty')">
                                    <div class="flex items-center justify-end gap-1">
                                        <span>采购订单.数量</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-600" x-show="sort.column !== 'purchase_order_qty'"></i>
                                        <i data-lucide="arrow-up" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'purchase_order_qty' && sort.direction === 'asc'"></i>
                                        <i data-lucide="arrow-down" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'purchase_order_qty' && sort.direction === 'desc'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'purchase_order_qty')"></div>
                                </th>
                                <!-- 领料/入库列 -->
                                <th scope="col" :class="{ 'col-hidden': !colVisible('pick_actual_qty') }"
                                    @click="toggleSort('pick_actual_qty')"
                                    :aria-sort="sort.column === 'pick_actual_qty' ? (sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
                                    class="px-4 py-3 text-right font-medium text-slate-400 bg-slate-900 whitespace-nowrap border-l border-sky-900 sortable-header relative resizable"
                                    :style="getColumnStyle('pick_actual_qty')">
                                    <div class="flex items-center justify-end gap-1">
                                        <span>生产领料单.实发数量</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-600" x-show="sort.column !== 'pick_actual_qty'"></i>
                                        <i data-lucide="arrow-up" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'pick_actual_qty' && sort.direction === 'asc'"></i>
                                        <i data-lucide="arrow-down" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'pick_actual_qty' && sort.direction === 'desc'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'pick_actual_qty')"></div>
                                </th>
                                <th scope="col" :class="{ 'col-hidden': !colVisible('prod_instock_real_qty') }"
                                    @click="toggleSort('prod_instock_real_qty')"
                                    :aria-sort="sort.column === 'prod_instock_real_qty' ? (sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
                                    class="px-4 py-3 text-right font-medium text-sky-400 bg-slate-900 whitespace-nowrap sortable-header relative resizable"
                                    :style="getColumnStyle('prod_instock_real_qty')">
                                    <div class="flex items-center justify-end gap-1">
                                        <span>生产入库单.实收数量</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-600" x-show="sort.column !== 'prod_instock_real_qty'"></i>
                                        <i data-lucide="arrow-up" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'prod_instock_real_qty' && sort.direction === 'asc'"></i>
                                        <i data-lucide="arrow-down" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'prod_instock_real_qty' && sort.direction === 'desc'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'prod_instock_real_qty')"></div>
                                </th>
                                <th scope="col" :class="{ 'col-hidden': !colVisible('purchase_stock_in_qty') }"
                                    @click="toggleSort('purchase_stock_in_qty')"
                                    :aria-sort="sort.column === 'purchase_stock_in_qty' ? (sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
                                    class="px-4 py-3 text-right font-medium text-sky-400 bg-slate-900 whitespace-nowrap border-r border-sky-900 sortable-header relative resizable"
                                    :style="getColumnStyle('purchase_stock_in_qty')">
                                    <div class="flex items-center justify-end gap-1">
                                        <span>采购订单.累计入库数量</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-600" x-show="sort.column !== 'purchase_stock_in_qty'"></i>
                                        <i data-lucide="arrow-up" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'purchase_stock_in_qty' && sort.direction === 'asc'"></i>
                                        <i data-lucide="arrow-down" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'purchase_stock_in_qty' && sort.direction === 'desc'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'purchase_stock_in_qty')"></div>
                                </th>
                                <!-- 完成率（语义层） -->
                                <th scope="col" :class="{ 'col-hidden': !colVisible('fulfillment_rate') }"
                                    @click="toggleSort('fulfillment_rate')"
                                    :aria-sort="sort.column === 'fulfillment_rate' ? (sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
                                    class="px-4 py-3 text-center font-medium text-amber-400 bg-slate-900 whitespace-nowrap border-l border-amber-900/50 sortable-header relative resizable"
                                    :style="getColumnStyle('fulfillment_rate')">
                                    <div class="flex items-center justify-center gap-1">
                                        <span>完成率</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-600" x-show="sort.column !== 'fulfillment_rate'"></i>
                                        <i data-lucide="arrow-up" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'fulfillment_rate' && sort.direction === 'asc'"></i>
                                        <i data-lucide="arrow-down" class="w-3 h-3 text-emerald-400" x-show="sort.column === 'fulfillment_rate' && sort.direction === 'desc'"></i>
                                    </div>
                                    <div class="resize-handle" @mousedown.stop="startResize($event, 'fulfillment_rate')"></div>
                                </th>
                            </tr>
                        </thead>
                        <tbody role="rowgroup">
                            <template x-for="(item, index) in getSortedItems()" :key="item.material_code + '-' + index">
                                <tr role="row" class="border-b border-slate-800 hover:bg-slate-800/50 transition">
                                    <td :class="{ 'col-hidden': !colVisible('index') }" role="cell" class="px-4 py-3 text-slate-500 bg-slate-900 sticky left-0 z-[5]" x-text="index + 1"></td>
                                    <td :class="{ 'col-hidden': !colVisible('material_code') }" role="cell" class="px-4 py-3 font-mono text-sm text-slate-300" x-text="item.material_code"></td>
                                    <td :class="{ 'col-hidden': !colVisible('material_name') }" role="cell" class="px-4 py-3 text-slate-200" x-text="item.material_name"></td>
                                    <td :class="{ 'col-hidden': !colVisible('specification') }" role="cell" class="px-4 py-3 text-slate-400" x-text="item.specification || '-'"></td>
                                    <!-- BOM简称 - only for 07.xx.xxx (成品) -->
                                    <td :class="{ 'col-hidden': !colVisible('bom_short_name') }" role="cell" class="px-4 py-3 text-slate-400"
                                        x-text="item.material_code?.startsWith('07') ? (item.bom_short_name || '-') : '-'"></td>
                                    <td :class="{ 'col-hidden': !colVisible('aux_attributes') }" role="cell" class="px-4 py-3 text-slate-400 text-xs max-w-[200px] truncate"
                                        :title="item.aux_attributes || ''"
                                        x-text="item.aux_attributes || '-'"></td>
                                    <td :class="{ 'col-hidden': !colVisible('material_type') }" role="cell" class="px-4 py-3">
                                        <span class="px-2 py-1 rounded text-xs font-medium"
                                              :class="getMaterialTypeBadge(item.material_type)"
                                              x-text="item.material_type"></span>
                                    </td>
                                    <!-- 绿色组: 数量列 (根据物料类型显示) -->
                                    <td :class="{ 'col-hidden': !colVisible('sales_order_qty') }" role="cell"
                                        class="px-4 py-3 text-right font-medium text-slate-200 bg-emerald-950/10"
                                        x-text="item.material_code?.startsWith('07') ? formatNumber(item.sales_order_qty) : '-'"></td>
                                    <td :class="{ 'col-hidden': !colVisible('prod_instock_must_qty') }" role="cell" class="px-4 py-3 text-right font-medium text-slate-200 bg-emerald-950/10"
                                        x-text="item.material_code?.startsWith('05') ? formatNumber(item.prod_instock_must_qty) : '-'"></td>
                                    <td :class="{ 'col-hidden': !colVisible('purchase_order_qty') }" role="cell" class="px-4 py-3 text-right font-medium text-slate-200 bg-emerald-950/10"
                                        x-text="item.material_code?.startsWith('03') ? formatNumber(item.purchase_order_qty) : '-'"></td>
                                    <!-- 领料/入库列 -->
                                    <td :class="{ 'col-hidden': !colVisible('pick_actual_qty') }" role="cell" class="px-4 py-3 text-right text-slate-300 bg-sky-950/10"
                                        x-text="['03', '05'].some(p => item.material_code?.startsWith(p)) ? formatNumber(item.pick_actual_qty) : '-'"></td>
                                    <td :class="{ 'col-hidden': !colVisible('prod_instock_real_qty') }" role="cell" class="px-4 py-3 text-right text-slate-300 bg-sky-950/10"
                                        x-text="['05', '07'].some(p => item.material_code?.startsWith(p)) ? formatNumber(item.prod_instock_real_qty) : '-'"></td>
                                    <td :class="{ 'col-hidden': !colVisible('purchase_stock_in_qty') }" role="cell" class="px-4 py-3 text-right text-slate-300 bg-sky-950/10"
                                        x-text="item.material_code?.startsWith('03') ? formatNumber(item.purchase_stock_in_qty) : '-'"></td>
                                    <!-- 完成率 -->
                                    <td role="cell"
                                        class="px-4 py-3 text-center font-medium"
                                        :class="{ 'col-hidden': !colVisible('fulfillment_rate'), [getStatusColor(getCompletionStatus(item))]: getFulfillmentRate(item) !== null, [getStatusBgColor(getCompletionStatus(item))]: getFulfillmentRate(item) !== null }">
                                        <span x-show="getFulfillmentRate(item) !== null" x-text="formatPercent(getFulfillmentRate(item))"></span>
                                        <span x-show="getFulfillmentRate(item) === null" class="text-slate-600 cursor-help" title="语义层数据不可用">-</span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                        <tfoot class="sticky bottom-0 z-10" x-data="{ get totals() { return calculateTotals() } }">
                            <tr class="border-t-2 border-slate-600 bg-slate-800 font-semibold">
                                <td :class="{ 'col-hidden': !colVisible('index') }" class="px-4 py-3 text-slate-400 bg-slate-800 sticky left-0 z-20">合计</td>
                                <td :class="{ 'col-hidden': !colVisible('material_code') }" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <td :class="{ 'col-hidden': !colVisible('material_name') }" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <td :class="{ 'col-hidden': !colVisible('specification') }" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <td :class="{ 'col-hidden': !colVisible('bom_short_name') }" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <td :class="{ 'col-hidden': !colVisible('aux_attributes') }" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <td :class="{ 'col-hidden': !colVisible('material_type') }" class="px-4 py-3 text-slate-400 bg-slate-800"></td>
                                <!-- 绿色组合计 -->
                                <td :class="{ 'col-hidden': !colVisible('sales_order_qty') }" class="px-4 py-3 text-right text-emerald-400 bg-slate-800"
                                    x-text="formatNumber(totals.sales_order_qty)"></td>
                                <td :class="{ 'col-hidden': !colVisible('prod_instock_must_qty') }" class="px-4 py-3 text-right text-emerald-400 bg-slate-800"
                                    x-text="formatNumber(totals.prod_instock_must_qty)"></td>
                                <td :class="{ 'col-hidden': !colVisible('purchase_order_qty') }" class="px-4 py-3 text-right text-emerald-400 bg-slate-800"
                                    x-text="formatNumber(totals.purchase_order_qty)"></td>
                                <!-- 领料/入库合计 -->
                                <td :class="{ 'col-hidden': !colVisible('pick_actual_qty') }" class="px-4 py-3 text-right text-sky-400 bg-slate-800"
                                    x-text="formatNumber(totals.pick_actual_qty)"></td>
                                <td :class="{ 'col-hidden': !colVisible('prod_instock_real_qty') }" class="px-4 py-3 text-right text-sky-400 bg-slate-800"
                                    x-text="formatNumber(totals.prod_instock_real_qty)"></td>
                                <td :class="{ 'col-hidden': !colVisible('purchase_stock_in_qty') }" class="px-4 py-3 text-right text-sky-400 bg-slate-800"
                                    x-text="formatNumber(totals.purchase_stock_in_qty)"></td>
                                <!-- 完成率合计 - 留空 (百分比合计无意义) -->
                                <td :class="{ 'col-hidden': !colVisible('fulfillment_rate') }" class="px-4 py-3 text-center text-slate-500 bg-slate-800">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="bom-cards">
                    <template x-for="(item, index) in getSortedItems()" :key="`card-${item.material_code}-${index}`">
                        <div class="bom-card">
                            <div class="bom-card-header">
                                <div>
                                    <div class="font-mono text-sm text-slate-300" x-text="item.material_code"></div>
                                    <div class="text-slate-200 mt-1" x-text="item.material_name"></div>
                                    <div class="text-slate-500 text-xs mt-1" x-show="item.aux_attributes" x-text="item.aux_attributes"></div>
                                </div>
                                <span class="px-2 py-1 rounded text-xs font-medium"
                                      :class="getMaterialTypeBadge(item.material_type)"
                                      x-text="item.material_type"></span>
                            </div>
                            <div class="bom-card-grid">
                                <!-- 数量列：根据物料类型显示 -->
                                <div class="bom-card-item" x-show="item.material_code?.startsWith('07')">
                                    <span class="bom-card-label">销售订单.数量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.sales_order_qty)"></span>
                                </div>
                                <div class="bom-card-item" x-show="item.material_code?.startsWith('05')">
                                    <span class="bom-card-label">生产入库单.应收数量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.prod_instock_must_qty)"></span>
                                </div>
                                <div class="bom-card-item" x-show="item.material_code?.startsWith('03')">
                                    <span class="bom-card-label">采购订单.数量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.purchase_order_qty)"></span>
                                </div>
                                <!-- 领料/入库列 -->
                                <div class="bom-card-item" x-show="['03', '05'].some(p => item.material_code?.startsWith(p))">
                                    <span class="bom-card-label">生产领料单.实发数量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.pick_actual_qty)"></span>
                                </div>
                                <div class="bom-card-item" x-show="['05', '07'].some(p => item.material_code?.startsWith(p))">
                                    <span class="bom-card-label">生产入库单.实收数量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.prod_instock_real_qty)"></span>
                                </div>
                                <div class="bom-card-item" x-show="item.material_code?.startsWith('03')">
                                    <span class="bom-card-label">采购订单.累计入库数量</span>
                                    <span class="bom-card-value" x-text="formatNumber(item.purchase_stock_in_qty)"></span>
                                </div>
                                <!-- 完成率 -->
                                <div class="bom-card-item">
                                    <span class="bom-card-label">完成率</span>
                                    <span x-show="getFulfillmentRate(item) !== null"
                                          class="bom-card-value font-medium"
                                          :class="getStatusColor(getCompletionStatus(item))"
                                          x-text="formatPercent(getFulfillmentRate(item))"></span>
                                    <span x-show="getFulfillmentRate(item) === null"
                                          class="bom-card-value text-slate-600 cursor-help"
                                          title="语义层数据不可用">-</span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="bg-slate-800/50 px-6 py-4 border-t border-slate-700">
                    <div class="flex items-center justify-between text-sm">
                        <div class="text-slate-400">
                            显示 <span class="font-bold text-slate-200" x-text="getSortedItems().length"></span> / <span x-text="childItems.length"></span> 条记录
                            <span x-show="hasActiveFilters()" class="ml-2 text-emerald-400">(已筛选)</span>
                        </div>
                        <div class="flex items-center gap-6 text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-violet-500 rounded"></div>
                                <span class="text-slate-400">成品 (07.xx)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-emerald-500 rounded"></div>
                                <span class="text-slate-400">自制 (05.xx)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-sky-500 rounded"></div>
                                <span class="text-slate-400">包材 (03.xx)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="childItems.length > 0" x-transition
                 class="mt-6 bg-slate-900 border border-slate-800 rounded overflow-hidden">
                <div class="bg-slate-800 px-6 py-4 flex items-center justify-between cursor-pointer"
                     @click="relatedOrdersExpanded = !relatedOrdersExpanded">
                    <h2 class="text-lg font-semibold text-slate-50 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                        订单关联图
                    </h2>
                    <div class="flex items-center gap-2 text-sm text-slate-400">
                        <span x-text="relatedOrdersExpanded ? '收起' : '展开'"></span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" x-show="relatedOrdersExpanded"><polyline points="18 15 12 9 6 15"/></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" x-show="!relatedOrdersExpanded"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                </div>

                <div x-show="relatedOrdersExpanded" class="p-6 space-y-4">
                    <div x-show="relatedOrdersLoading" class="text-slate-400 text-sm">
                        正在加载关联单据...
                    </div>
                    <div x-show="relatedOrdersError" class="text-rose-400 text-sm" x-text="relatedOrdersError"></div>

                    <template x-if="!relatedOrdersLoading && hasRelatedOrders()">
                        <div class="tree-container">
                            <div class="tree-node tree-root">
                                <span class="tree-label">MTO号</span>
                                <span class="tree-value" x-text="mtoNumber"></span>
                            </div>
                            <div class="tree-children">
                                <div class="space-y-3">
                                    <template x-for="order in relatedOrders.orders.sales_orders" :key="`so-${order.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-sales">
                                                <span class="tree-label" x-text="order.label"></span>
                                                <span class="tree-value" x-text="order.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="doc in relatedOrders.documents.sales_deliveries" :key="`sd-${doc.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-sales tree-doc">
                                                <span class="tree-label" x-text="doc.label"></span>
                                                <span class="tree-value" x-text="doc.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <div class="space-y-3">
                                    <template x-for="order in relatedOrders.orders.production_orders" :key="`po-${order.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-production">
                                                <span class="tree-label" x-text="order.label"></span>
                                                <span class="tree-value" x-text="order.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="doc in relatedOrders.documents.production_receipts" :key="`pr-${doc.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-production tree-doc">
                                                <span class="tree-label" x-text="doc.label"></span>
                                                <span class="tree-value" x-text="doc.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="doc in relatedOrders.documents.material_pickings" :key="`mp-${doc.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-production tree-doc">
                                                <span class="tree-label" x-text="doc.label"></span>
                                                <span class="tree-value" x-text="doc.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <div class="space-y-3">
                                    <template x-for="order in relatedOrders.orders.purchase_orders" :key="`pu-${order.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-purchase">
                                                <span class="tree-label" x-text="order.label"></span>
                                                <span class="tree-value" x-text="order.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="doc in relatedOrders.documents.purchase_receipts" :key="`prc-${doc.bill_no}`">
                                        <div class="tree-branch">
                                            <div class="tree-node tree-purchase tree-doc">
                                                <span class="tree-label" x-text="doc.label"></span>
                                                <span class="tree-value" x-text="doc.bill_no"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="!relatedOrdersLoading && !relatedOrdersError && !hasRelatedOrders()" class="text-slate-500 text-sm">
                        暂无关联单据
                    </div>
                </div>
            </div>

            <div x-show="loading" class="bg-slate-900 border border-slate-800 rounded p-6">
                <div class="space-y-4">
                    <template x-for="i in 5" :key="i">
                        <div class="flex gap-4">
                            <div class="skeleton h-4 w-12 rounded"></div>
                            <div class="skeleton h-4 w-32 rounded"></div>
                            <div class="skeleton h-4 flex-1 rounded"></div>
                            <div class="skeleton h-4 w-20 rounded"></div>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="!loading && childItems.length === 0 && !error" class="text-center py-20">
                <i data-lucide="inbox" class="w-16 h-16 text-slate-700 mx-auto mb-4"></i>
                <h3 class="text-lg text-slate-400 mb-2">暂无数据</h3>
                <p class="text-slate-600 text-sm">请输入MTO单号进行查询</p>
            </div>
        </main>

        <div class="fixed bottom-4 text-xs text-slate-600 no-print" x-show="childItems.length > 0"
             :class="chatOpen ? 'right-[400px]' : 'right-4'"
             :style="{ transition: 'right 0.3s ease' }">
            <span class="px-2 py-1 bg-slate-800 rounded mr-1">F11</span> 全屏
            <span class="px-2 py-1 bg-slate-800 rounded mr-1 ml-2">ESC</span> 退出
        </div>

        <div aria-live="polite" aria-atomic="true" class="sr-only"
             x-text="loading ? '正在加载...' : (error ? '发生错误: ' + error : (parentItem ? '已加载MTO单号 ' + mtoNumber + ' 的数据' : ''))">
        </div>
        </div><!-- /.chat-content-push -->

        <!-- ====== Chat Sidebar ====== -->
        <template x-if="chatAvailable">
            <!-- Toggle button (always visible when chat is available) -->
            <button @click="toggleChat()"
                    x-show="!chatOpen"
                    class="fixed bottom-6 right-6 z-40 w-12 h-12 bg-emerald-600 hover:bg-emerald-500 text-white rounded-full shadow-lg flex items-center justify-center transition-all no-print"
                    title="AI 助手">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                </svg>
            </button>
        </template>

        <template x-if="chatAvailable">
            <div class="chat-sidebar no-print"
                 role="complementary" aria-label="AI 助手"
                 :class="chatOpen ? 'chat-sidebar-open' : 'chat-sidebar-closed'"
                 @keydown="trapFocusInChat($event)"
                 x-effect="if (chatOpen) { $nextTick(() => { const ta = $el.querySelector('textarea'); if (ta) ta.focus(); }) }">
                <!-- Header -->
                <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700 bg-slate-900 flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                        <span class="text-sm font-medium text-slate-200">AI 助手</span>
                        <!-- Mode toggle (only when agent mode is available) -->
                        <template x-if="agentChatAvailable">
                            <div class="flex items-center rounded overflow-hidden border border-slate-600 ml-1">
                                <button @click="switchChatMode('simple')"
                                        class="px-2 py-0.5 text-xs transition"
                                        :class="chatMode === 'simple' ? 'bg-emerald-600 text-white' : 'bg-slate-700 text-slate-400 hover:text-slate-300'">
                                    简单
                                </button>
                                <button @click="switchChatMode('agent')"
                                        class="px-2 py-0.5 text-xs transition"
                                        title="使用多Agent协作进行更深入的分析"
                                        :class="chatMode === 'agent' ? 'bg-emerald-600 text-white' : 'bg-slate-700 text-slate-400 hover:text-slate-300'">
                                    智能
                                </button>
                            </div>
                        </template>
                        <!-- Provider selector (only when multiple providers available) -->
                        <template x-if="chatProviders.length > 1 && chatMode !== 'agent'">
                            <select @change="switchProvider($event.target.value)"
                                    class="text-xs bg-slate-700 text-slate-300 border border-slate-600 rounded px-1.5 py-0.5 ml-1 focus:outline-none focus:border-emerald-500"
                                    :value="activeProvider">
                                <template x-for="p in chatProviders" :key="p.name">
                                    <option :value="p.name" x-text="p.label" :selected="p.name === activeProvider"></option>
                                </template>
                            </select>
                        </template>
                        <span class="text-xs text-slate-500" x-text="chatMode === 'agent' ? '多Agent协作分析' : (chatModel || '')"></span>
                    </div>
                    <div class="flex items-center gap-1">
                        <button @click="clearChat()" aria-label="Clear chat" class="p-1.5 text-slate-400 hover:text-slate-200 rounded transition" title="清空对话">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                        <button @click="toggleChat()" aria-label="Close chat" class="p-1.5 text-slate-400 hover:text-slate-200 rounded transition" title="关闭">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Messages -->
                <div class="flex-1 overflow-y-auto px-4 py-3 space-y-3 chat-messages" x-ref="chatMessages">
                    <!-- Welcome message -->
                    <template x-if="chatMessages.length === 0">
                        <div class="text-center py-8">
                            <div class="text-slate-500 text-sm mb-3">
                                <span>输入自然语言查询，AI 会生成SQL分析</span>
                            </div>
                            <div class="space-y-2">
                                <div class="space-y-1">
                                    <button @click="chatInput = '最近一周有多少个MTO在生产？'; sendChat()"
                                            class="block w-full text-left text-xs text-slate-400 hover:text-emerald-400 bg-slate-800/50 rounded px-3 py-2 transition">
                                        最近一周有多少个MTO在生产？
                                    </button>
                                    <button @click="chatInput = '哪些物料采购入库率最低？'; sendChat()"
                                            class="block w-full text-left text-xs text-slate-400 hover:text-emerald-400 bg-slate-800/50 rounded px-3 py-2 transition">
                                        哪些物料采购入库率最低？
                                    </button>
                                    <button @click="chatInput = '本月交货的MTO有哪些？'; sendChat()"
                                            class="block w-full text-left text-xs text-slate-400 hover:text-emerald-400 bg-slate-800/50 rounded px-3 py-2 transition">
                                        本月交货的MTO有哪些？
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Message list -->
                    <template x-for="(msg, idx) in chatMessages" :key="idx">
                        <div :class="msg.role === 'user' ? 'chat-msg-user' : 'chat-msg-assistant'">
                            <div class="text-xs text-slate-500 mb-1" x-text="msg.role === 'user' ? '你' : 'AI'"></div>
                            <div class="chat-msg-content text-sm text-slate-200 leading-relaxed"
                                 x-html="renderChatContent(msg.content)">
                            </div>
                            <!-- SQL block (analytics mode) -->
                            <template x-if="msg.sql">
                                <div class="mt-2 bg-slate-950 rounded p-2 text-xs font-mono text-green-400 overflow-x-auto">
                                    <div class="text-slate-500 mb-1">SQL</div>
                                    <pre x-text="msg.sql"></pre>
                                </div>
                            </template>
                            <!-- SQL result table -->
                            <template x-if="msg.sqlResult">
                                <div class="mt-2 overflow-x-auto">
                                    <table class="text-xs w-full border-collapse">
                                        <thead>
                                            <tr>
                                                <template x-for="col in msg.sqlResult.columns" :key="col">
                                                    <th class="border border-slate-700 bg-slate-800 px-2 py-1 text-left text-slate-300" x-text="col"></th>
                                                </template>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="(row, ri) in msg.sqlResult.rows.slice(0, 20)" :key="ri">
                                                <tr>
                                                    <template x-for="(cell, ci) in row" :key="ci">
                                                        <td class="border border-slate-700 px-2 py-1 text-slate-400" x-text="cell"></td>
                                                    </template>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                    <template x-if="msg.sqlResult.total_rows > 20">
                                        <div class="text-xs text-slate-500 mt-1" x-text="'共 ' + msg.sqlResult.total_rows + ' 行，显示前 20 行'"></div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Streaming indicator -->
                    <div x-show="chatLoading" class="chat-msg-assistant">
                        <div class="text-xs text-slate-500 mb-1">AI</div>
                        <div class="flex items-center gap-1 text-slate-400 text-sm">
                            <span class="chat-typing-dot"></span>
                            <span class="chat-typing-dot" style="animation-delay: 0.2s"></span>
                            <span class="chat-typing-dot" style="animation-delay: 0.4s"></span>
                        </div>
                    </div>
                </div>

                <!-- Input area -->
                <div class="border-t border-slate-700 px-4 py-3 bg-slate-900 flex-shrink-0">
                    <div class="flex gap-2">
                        <textarea x-model="chatInput"
                                  @keydown.enter.prevent="if (!$event.shiftKey) sendChat()"
                                  :disabled="chatLoading"
                                  rows="1"
                                  class="flex-1 bg-slate-800 text-slate-200 text-sm rounded-lg px-3 py-2 border border-slate-700 focus:border-emerald-500 focus:outline-none resize-none placeholder-slate-500"
                                  placeholder="输入数据查询需求..."
                                  @input="$el.style.height = 'auto'; $el.style.height = Math.min($el.scrollHeight, 120) + 'px'">
                        </textarea>
                        <button @click="sendChat()"
                                :disabled="chatLoading || !chatInput.trim()"
                                aria-label="Send message"
                                class="px-3 py-2 bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-700 disabled:text-slate-500 text-white rounded-lg transition flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script src="/static/js/api.js?v=20260202b"></script>
    <script src="/static/js/auth.js?v=20260202b"></script>
    <script src="/static/js/dashboard.js?v=20260202b"></script>
    <script>
        // Initialize Lucide icons once on page load
        lucide.createIcons();

        // Debounced icon refresh for dynamic content
        let iconRefreshTimeout = null;
        function refreshIcons() {
            if (iconRefreshTimeout) clearTimeout(iconRefreshTimeout);
            iconRefreshTimeout = setTimeout(() => {
                lucide.createIcons();
            }, 100);
        }

        // Only refresh icons after Alpine finishes major updates
        document.addEventListener('alpine:initialized', () => {
            // Refresh icons once after Alpine initializes
            refreshIcons();
        });
    </script>
</body>
</html>
