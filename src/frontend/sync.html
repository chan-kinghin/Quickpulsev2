<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickPulse V2 - 同步管理</title>

    <!-- Pre-built Tailwind CSS (no CDN dependency — reliable in China) -->
    <link rel="stylesheet" href="/static/css/tailwind.min.css">
    <link rel="stylesheet" href="/static/css/main.css">

    <!-- Serve Alpine.js and Lucide locally for reliability in China -->
    <script defer src="/static/js/alpine.min.js"></script>
    <script src="/static/js/lucide.min.js"></script>
</head>
<body class="bg-slate-950 min-h-screen" x-data="authGuard()">
    <div x-data="syncPanel()" x-init="init()">
        <header class="bg-slate-900 border-b border-slate-800 px-6 py-4">
            <div class="flex items-center justify-between max-w-4xl mx-auto">
                <div class="flex items-center gap-4">
                    <a href="/dashboard.html" class="text-slate-400 hover:text-slate-50 transition">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </a>
                    <h1 class="text-xl font-semibold text-slate-50">同步管理</h1>
                </div>
                <button @click="api.logout()" class="text-slate-400 hover:text-slate-50 text-sm transition">
                    退出登录
                </button>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-6 py-8">
            <!-- Sync Status -->
            <div class="bg-slate-900 border border-slate-800 rounded p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-slate-50">同步状态</h2>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full animate-pulse"
                              :class="status.is_running ? 'bg-amber-500' : 'bg-emerald-500'"></span>
                        <span class="text-sm" :class="status.is_running ? 'text-amber-400' : 'text-emerald-400'"
                              x-text="status.is_running ? '同步中...' : '空闲'"></span>
                    </div>
                </div>

                <div x-show="status.is_running" class="mb-4">
                    <div class="h-2 bg-slate-800 rounded overflow-hidden">
                        <div class="h-full bg-emerald-500 transition-all duration-300"
                             :style="`width: ${status.progress || 0}%`"></div>
                    </div>
                    <p class="text-sm text-slate-400 mt-2" x-text="status.current_task || '处理中...'"></p>
                </div>

                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-slate-500">上次同步</span>
                        <p class="text-slate-200 mt-1" x-text="status.last_sync || '从未同步'"></p>
                    </div>
                    <div>
                        <span class="text-slate-500">同步记录数</span>
                        <p class="text-slate-200 mt-1" x-text="status.records_synced || '-'"></p>
                    </div>
                </div>
            </div>

            <!-- Manual Sync -->
            <div class="bg-slate-900 border border-slate-800 rounded p-6 mb-6">
                <h2 class="text-lg font-semibold text-slate-50 mb-4">手动同步</h2>
                <div class="flex gap-4 items-end">
                    <div class="flex-1">
                        <label class="block text-sm text-slate-400 mb-2">同步天数</label>
                        <input type="number" x-model="daysBack" min="1" max="365"
                               class="w-full bg-slate-800 border border-slate-700 text-slate-50 px-4 py-3 rounded focus:outline-none glow-emerald transition">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="force-sync" x-model="forceSync"
                               class="w-4 h-4 bg-slate-800 border border-slate-700 rounded">
                        <label for="force-sync" class="text-sm text-slate-400">强制刷新</label>
                    </div>
                    <button @click="triggerSync()" :disabled="status.is_running || loading"
                            class="px-6 py-3 bg-emerald-500 hover:bg-emerald-400 disabled:bg-slate-700 disabled:cursor-not-allowed text-slate-950 font-medium rounded transition">
                        <span x-text="loading ? '触发中...' : '开始同步'"></span>
                    </button>
                </div>
            </div>

            <!-- Config Editor (replaces static auto sync section) -->
            <div class="bg-slate-900 border border-slate-800 rounded p-6 mb-6">
                <h2 class="text-lg font-semibold text-slate-50 mb-4">
                    <span class="inline-flex items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5 text-slate-400"></i>
                        自动同步配置
                    </span>
                </h2>

                <div class="space-y-4">
                    <!-- Auto sync toggle -->
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-slate-300">启用自动同步</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="config.auto_sync_enabled" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-400 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600 peer-checked:after:bg-white"></div>
                        </label>
                    </div>

                    <!-- Schedule (read-only) -->
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">同步时间表</label>
                        <p class="text-sm text-slate-200" x-text="config.auto_sync_schedule && config.auto_sync_schedule.length ? config.auto_sync_schedule.join(', ') : '未设置'"></p>
                        <p class="text-xs text-slate-500 mt-1">时间表仅在配置文件中修改</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- Auto sync days -->
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">自动同步天数</label>
                            <input type="number" x-model="config.auto_sync_days" min="1" max="365"
                                   class="w-full bg-slate-800 border border-slate-700 text-slate-50 px-4 py-3 rounded focus:outline-none glow-emerald transition">
                        </div>
                        <!-- Manual default days -->
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">手动同步默认天数</label>
                            <input type="number" x-model="config.manual_sync_default_days" min="1" max="365"
                                   class="w-full bg-slate-800 border border-slate-700 text-slate-50 px-4 py-3 rounded focus:outline-none glow-emerald transition">
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <button @click="saveConfig()" :disabled="configLoading || !isConfigDirty()"
                                class="px-6 py-2.5 bg-emerald-500 hover:bg-emerald-400 disabled:bg-slate-700 disabled:cursor-not-allowed text-slate-950 font-medium rounded text-sm transition">
                            <span x-text="configLoading ? '保存中...' : '保存'"></span>
                        </button>
                        <span x-show="!configLoading && !isConfigDirty() && !configMsg" class="text-xs text-slate-500">未修改</span>
                        <span x-show="configMsg" x-transition class="text-sm"
                              :class="configMsgType === 'success' ? 'text-emerald-400' : 'text-rose-400'"
                              x-text="configMsg"></span>
                    </div>
                </div>
            </div>

            <!-- Sync History -->
            <div class="bg-slate-900 border border-slate-800 rounded p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-slate-50">
                        <span class="inline-flex items-center gap-2">
                            <i data-lucide="history" class="w-5 h-5 text-slate-400"></i>
                            同步历史
                        </span>
                    </h2>
                    <button @click="fetchHistory()" class="text-slate-400 hover:text-slate-50 text-sm transition">
                        <i data-lucide="refresh-cw" class="w-4 h-4 inline"></i> 刷新
                    </button>
                </div>

                <div x-show="historyLoading" class="space-y-3 py-2">
                    <template x-for="i in 3" :key="i">
                        <div class="flex gap-4">
                            <div class="skeleton h-4 w-32 rounded"></div>
                            <div class="skeleton h-4 w-32 rounded"></div>
                            <div class="skeleton h-4 w-16 rounded"></div>
                            <div class="skeleton h-4 w-12 rounded"></div>
                            <div class="skeleton h-4 w-16 rounded"></div>
                        </div>
                    </template>
                </div>

                <div x-show="!historyLoading && history.length === 0" class="text-center py-8">
                    <i data-lucide="clock" class="w-10 h-10 text-slate-700 mx-auto mb-2"></i>
                    <p class="text-sm text-slate-500">暂无同步历史记录</p>
                </div>

                <div x-show="!historyLoading && history.length > 0" class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-slate-500 border-b border-slate-800">
                                <th class="pb-2 pr-4 font-medium">开始时间</th>
                                <th class="pb-2 pr-4 font-medium">结束时间</th>
                                <th class="pb-2 pr-4 font-medium">状态</th>
                                <th class="pb-2 pr-4 font-medium text-right">天数</th>
                                <th class="pb-2 pr-4 font-medium text-right">记录数</th>
                                <th class="pb-2 font-medium">错误信息</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="item in history" :key="item.started_at">
                                <tr class="border-b border-slate-800/50">
                                    <td class="py-2.5 pr-4 text-slate-300" x-text="formatDate(item.started_at)"></td>
                                    <td class="py-2.5 pr-4 text-slate-300" x-text="formatDate(item.finished_at)"></td>
                                    <td class="py-2.5 pr-4">
                                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium"
                                              :class="statusBadgeClass(item.status)">
                                            <i :data-lucide="(item.status === 'completed' || item.status === 'success') ? 'check' : item.status === 'failed' ? 'x' : 'loader'"
                                               class="w-3 h-3"></i>
                                            <span x-text="(item.status === 'completed' || item.status === 'success') ? '完成' : item.status === 'failed' ? '失败' : item.status === 'running' ? '运行中' : item.status"></span>
                                        </span>
                                    </td>
                                    <td class="py-2.5 pr-4 text-slate-300 text-right" x-text="item.days_back || '-'"></td>
                                    <td class="py-2.5 pr-4 text-slate-300 text-right" x-text="formatNumber(item.records_synced)"></td>
                                    <td class="py-2.5 text-rose-400 text-xs max-w-[200px] truncate" x-text="item.error_message || '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Cache Admin Panel -->
            <div class="bg-slate-900 border border-slate-800 rounded p-6 mb-6">
                <h2 class="text-lg font-semibold text-slate-50 mb-4">
                    <span class="inline-flex items-center gap-2">
                        <i data-lucide="database" class="w-5 h-5 text-slate-400"></i>
                        缓存管理
                    </span>
                </h2>

                <!-- Cache Stats -->
                <div x-show="cacheStats" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                    <div class="bg-slate-800/50 rounded p-3">
                        <p class="text-xs text-slate-500">内存缓存条目</p>
                        <p class="text-lg font-semibold text-slate-50" x-text="cacheStats ? (cacheStats.memory_cache.size + ' / ' + cacheStats.memory_cache.max_size) : '-'"></p>
                    </div>
                    <div class="bg-slate-800/50 rounded p-3">
                        <p class="text-xs text-slate-500">缓存命中率</p>
                        <p class="text-lg font-semibold text-emerald-400" x-text="cacheStats ? formatPercent(cacheStats.memory_cache.hit_rate) : '-'"></p>
                    </div>
                    <div class="bg-slate-800/50 rounded p-3">
                        <p class="text-xs text-slate-500">持久化缓存</p>
                        <p class="text-lg font-semibold text-slate-50" x-text="cacheStats && cacheStats.sqlite_cache ? formatNumber(cacheStats.sqlite_cache.size || cacheStats.sqlite_cache.entries) : '-'"></p>
                    </div>
                    <div class="bg-slate-800/50 rounded p-3">
                        <p class="text-xs text-slate-500">累计查询次数</p>
                        <p class="text-lg font-semibold text-slate-50" x-text="cacheStats ? formatNumber(cacheStats.query_stats.total_queries) : '-'"></p>
                    </div>
                </div>
                <div x-show="!cacheStats && !cacheLoading" class="text-sm text-slate-500 mb-4">缓存统计暂不可用</div>

                <!-- Cache message -->
                <div x-show="cacheMsg" x-transition class="mb-4 px-3 py-2 rounded text-sm"
                     :class="cacheMsgType === 'success' ? 'bg-emerald-500/10 border border-emerald-500/30 text-emerald-400' : 'bg-rose-500/10 border border-rose-500/30 text-rose-400'"
                     x-text="cacheMsg"></div>

                <!-- Actions Row -->
                <div class="flex flex-wrap gap-3 mb-6">
                    <button @click="clearCache()"
                            title="清除所有内存和SQLite缓存数据"
                            class="px-4 py-2 rounded text-sm font-medium transition"
                            :class="clearCacheConfirm ? 'bg-rose-600 hover:bg-rose-500 text-white' : 'bg-rose-500/20 hover:bg-rose-500/30 text-rose-400 border border-rose-500/30'">
                        <i data-lucide="trash-2" class="w-4 h-4 inline -mt-0.5"></i>
                        <span x-text="clearCacheConfirm ? '确认清除？' : '清除缓存'"></span>
                    </button>
                    <button @click="resetCacheStats()"
                            title="重置命中率等统计计数器，不影响缓存数据"
                            class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-sm font-medium transition">
                        <i data-lucide="rotate-ccw" class="w-4 h-4 inline -mt-0.5"></i> 重置统计
                    </button>
                    <div class="flex items-center gap-2">
                        <input type="number" x-model="warmCount" min="1" max="500" placeholder="100"
                               class="w-20 bg-slate-800 border border-slate-700 text-slate-50 px-3 py-2 rounded text-sm focus:outline-none">
                        <button @click="warmCache()" :disabled="warmLoading"
                                title="预加载最近同步的MTO到内存缓存"
                                class="px-4 py-2 bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 border border-amber-500/30 disabled:opacity-50 rounded text-sm font-medium transition">
                            <span x-text="warmLoading ? '预热中...' : '预热缓存'"></span>
                        </button>
                    </div>
                </div>

                <!-- Invalidate MTO -->
                <div class="flex gap-3 items-end mb-6">
                    <div class="flex-1">
                        <label class="block text-sm text-slate-400 mb-2">失效指定 MTO 缓存</label>
                        <input type="text" x-model="invalidateMto" placeholder="输入 MTO 编号, 如 AK2510034"
                               @keydown.enter="doInvalidateMto()"
                               class="w-full bg-slate-800 border border-slate-700 text-slate-50 px-4 py-2.5 rounded text-sm focus:outline-none glow-emerald transition">
                    </div>
                    <button @click="doInvalidateMto()" :disabled="invalidateLoading || !invalidateMto.trim()"
                            class="px-4 py-2.5 bg-slate-700 hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed text-slate-300 rounded text-sm font-medium transition">
                        <span x-text="invalidateLoading ? '处理中...' : '失效'"></span>
                    </button>
                </div>

                <!-- Hot MTOs -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-medium text-slate-400">热门 MTO (Top 20)</h3>
                        <button @click="fetchHotMtos()" class="text-slate-500 hover:text-slate-300 text-xs transition">
                            <i data-lucide="refresh-cw" class="w-3.5 h-3.5 inline"></i> 刷新
                        </button>
                    </div>
                    <div x-show="hotMtosLoading" class="flex flex-wrap gap-2">
                        <template x-for="i in 8" :key="i">
                            <div class="skeleton h-7 w-24 rounded"></div>
                        </template>
                    </div>
                    <div x-show="!hotMtosLoading && hotMtos.length === 0" class="text-center py-4">
                        <i data-lucide="bar-chart-3" class="w-8 h-8 text-slate-700 mx-auto mb-1"></i>
                        <p class="text-xs text-slate-500">暂无热门查询数据</p>
                    </div>
                    <div x-show="!hotMtosLoading && hotMtos.length > 0" class="flex flex-wrap gap-2">
                        <template x-for="mto in hotMtos" :key="mto">
                            <span class="px-2.5 py-1 bg-slate-800 border border-slate-700 text-slate-300 rounded text-xs font-mono"
                                  x-text="mto"></span>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Error display -->
            <div x-show="error" x-transition
                 class="p-4 bg-rose-500/10 border border-rose-500/30 rounded text-rose-400 mb-6">
                <span x-text="error"></span>
            </div>
        </main>
    </div>

    <script src="/static/js/api.js?v=20260224b"></script>
    <script src="/static/js/auth.js?v=20260224b"></script>
    <script src="/static/js/sync.js?v=20260224b"></script>
    <script>
        lucide.createIcons();
        let iconRefreshTimeout = null;
        function refreshIcons() {
            if (iconRefreshTimeout) clearTimeout(iconRefreshTimeout);
            iconRefreshTimeout = setTimeout(() => lucide.createIcons(), 100);
        }
        document.addEventListener('alpine:initialized', () => {
            refreshIcons();
        });
    </script>
</body>
</html>
