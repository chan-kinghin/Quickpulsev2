<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickPulse V2 - 产品状态明细表</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom styles -->
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div x-data="mtoSearch()" x-init="init()" @keydown.escape.window="exitFullScreen()">

        <!-- Main Container -->
        <div :class="isFullScreen ? 'fixed inset-0 z-50 bg-white overflow-auto' : 'container mx-auto px-4 py-6'">

            <!-- Header -->
            <header :class="isFullScreen && isCollapsed ? 'hidden' : 'mb-6'" class="transition-all duration-300">
                <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl font-bold mb-2">QuickPulse V2</h1>
                            <p class="text-blue-100">产品状态明细表 - Product Status Detail Sheet</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-blue-100">ERP Integration Dashboard</div>
                            <div class="text-xs text-blue-200 mt-1" x-text="new Date().toLocaleString('zh-CN')"></div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Search Section -->
            <section :class="isFullScreen && isCollapsed ? 'hidden' : 'mb-6'" class="transition-all duration-300">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex gap-4 items-end">
                        <div class="flex-1">
                            <label for="mtoNumber" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-barcode mr-2"></i>MTO单号 (MTO Number)
                            </label>
                            <input
                                type="text"
                                id="mtoNumber"
                                x-model="mtoNumber"
                                @keydown.enter="search()"
                                placeholder="请输入MTO单号..."
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                                :disabled="loading"
                            >
                        </div>
                        <button
                            @click="search()"
                            :disabled="loading || !mtoNumber"
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition flex items-center gap-2 font-medium"
                        >
                            <i :class="loading ? 'fas fa-spinner fa-spin' : 'fas fa-search'"></i>
                            <span x-text="loading ? '查询中...' : '查询'"></span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Error Message -->
            <div x-show="error" x-transition class="mb-6">
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
                        <div>
                            <p class="text-red-800 font-medium">查询错误</p>
                            <p class="text-red-600 text-sm mt-1" x-text="error"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success Message -->
            <div x-show="successMessage" x-transition class="mb-6">
                <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-3"></i>
                        <p class="text-green-800" x-text="successMessage"></p>
                    </div>
                </div>
            </div>

            <!-- Parent Item Info Card -->
            <div x-show="parentItem" x-transition :class="isFullScreen && isCollapsed ? 'hidden' : 'mb-6'" class="transition-all duration-300">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gradient-to-r from-gray-700 to-gray-900 text-white px-6 py-4">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold flex items-center gap-2">
                                <i class="fas fa-cube"></i>
                                生产订单信息 (Production Order)
                            </h2>
                            <span class="bg-blue-500 px-3 py-1 rounded-full text-sm" x-show="childItems.length > 0" x-text="`${childItems.length} 个子项`"></span>
                        </div>
                    </div>
                    <div class="p-6">
                        <template x-if="parentItem">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="border-l-4 border-blue-500 pl-4">
                                    <div class="text-sm text-gray-600">物料编码</div>
                                    <div class="font-semibold text-gray-900 mt-1" x-text="parentItem.material_code"></div>
                                </div>
                                <div class="border-l-4 border-green-500 pl-4">
                                    <div class="text-sm text-gray-600">物料名称</div>
                                    <div class="font-semibold text-gray-900 mt-1" x-text="parentItem.material_name"></div>
                                </div>
                                <div class="border-l-4 border-purple-500 pl-4">
                                    <div class="text-sm text-gray-600">规格型号</div>
                                    <div class="font-semibold text-gray-900 mt-1" x-text="parentItem.specification || '-'"></div>
                                </div>
                                <div class="border-l-4 border-orange-500 pl-4">
                                    <div class="text-sm text-gray-600">订单数量</div>
                                    <div class="font-semibold text-gray-900 mt-1" x-text="parentItem.order_qty"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Child Items Table -->
            <div x-show="childItems.length > 0" x-transition class="bg-white rounded-lg shadow-md overflow-hidden">

                <!-- Table Header with Controls -->
                <div class="bg-gradient-to-r from-gray-700 to-gray-900 text-white px-6 py-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <i class="fas fa-list-ul"></i>
                            BOM组件明细 (BOM Components)
                        </h2>
                        <div class="flex items-center gap-3">
                            <!-- Collapse Toggle (only in fullscreen) -->
                            <button
                                x-show="isFullScreen"
                                @click="isCollapsed = !isCollapsed"
                                class="px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition flex items-center gap-2 text-sm"
                                title="显示/隐藏搜索区域"
                            >
                                <i :class="isCollapsed ? 'fas fa-chevron-down' : 'fas fa-chevron-up'"></i>
                                <span x-text="isCollapsed ? '展开' : '收起'"></span>
                            </button>

                            <!-- Export Button -->
                            <button
                                @click="exportToExcel()"
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition flex items-center gap-2"
                                title="导出Excel"
                            >
                                <i class="fas fa-file-excel"></i>
                                <span>导出</span>
                            </button>

                            <!-- Full Screen Toggle -->
                            <button
                                @click="toggleFullScreen()"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition flex items-center gap-2"
                                :title="isFullScreen ? '退出全屏 (ESC)' : '全屏查看'"
                            >
                                <i :class="isFullScreen ? 'fas fa-compress' : 'fas fa-expand'"></i>
                                <span x-text="isFullScreen ? '退出全屏' : '全屏'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="overflow-x-auto" :class="isFullScreen ? 'max-h-screen' : 'max-h-[600px]'">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0 z-10">
                            <tr class="border-b-2 border-gray-300">
                                <th class="px-4 py-3 text-left font-semibold text-gray-700 whitespace-nowrap">序号</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700 whitespace-nowrap min-w-[120px]">物料编码</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700 whitespace-nowrap min-w-[150px]">物料名称</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700 whitespace-nowrap min-w-[120px]">规格型号</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700 whitespace-nowrap">物料类型</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-700 whitespace-nowrap bg-blue-50">需求量</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-700 whitespace-nowrap bg-blue-50">已领量</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-700 whitespace-nowrap bg-blue-50">未领量</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-700 whitespace-nowrap bg-green-50">订单数量</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-700 whitespace-nowrap bg-green-50">入库量</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-700 whitespace-nowrap bg-green-50">未入库量</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-700 whitespace-nowrap bg-purple-50">销售出库</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-700 whitespace-nowrap bg-purple-50">即时库存</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(item, index) in childItems" :key="index">
                                <tr class="border-b border-gray-200 hover:bg-gray-50 transition">
                                    <td class="px-4 py-3 text-gray-600" x-text="index + 1"></td>
                                    <td class="px-4 py-3 font-mono text-sm" x-text="item.material_code"></td>
                                    <td class="px-4 py-3" x-text="item.material_name"></td>
                                    <td class="px-4 py-3 text-gray-600" x-text="item.specification || '-'"></td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium"
                                              :class="getMaterialTypeBadge(item.material_type)"
                                              x-text="item.material_type">
                                        </span>
                                    </td>
                                    <!-- 需求量 -->
                                    <td class="px-4 py-3 text-right font-medium bg-blue-50" x-text="formatNumber(item.required_qty)"></td>
                                    <!-- 已领量 -->
                                    <td class="px-4 py-3 text-right bg-blue-50" x-text="formatNumber(item.picked_qty)"></td>
                                    <!-- 未领量 (highlight if negative - 超领) -->
                                    <td class="px-4 py-3 text-right font-medium bg-blue-50"
                                        :class="isOverPicked(item.unpicked_qty) ? 'text-red-600 font-bold' : 'text-gray-900'"
                                    >
                                        <span x-text="formatNumber(item.unpicked_qty)"></span>
                                        <span x-show="isOverPicked(item.unpicked_qty)" class="text-xs ml-1">(超领)</span>
                                    </td>
                                    <!-- 订单数量 -->
                                    <td class="px-4 py-3 text-right bg-green-50" x-text="formatNumber(item.order_qty)"></td>
                                    <!-- 入库量 -->
                                    <td class="px-4 py-3 text-right bg-green-50" x-text="formatNumber(item.received_qty)"></td>
                                    <!-- 未入库量 -->
                                    <td class="px-4 py-3 text-right font-medium bg-green-50"
                                        :class="item.unreceived_qty > 0 ? 'text-orange-600' : 'text-green-600'"
                                        x-text="formatNumber(item.unreceived_qty)">
                                    </td>
                                    <!-- 销售出库 -->
                                    <td class="px-4 py-3 text-right bg-purple-50" x-text="formatNumber(item.sales_outbound_qty)"></td>
                                    <!-- 即时库存 -->
                                    <td class="px-4 py-3 text-right font-medium bg-purple-50"
                                        :class="item.current_stock <= 0 ? 'text-red-600' : 'text-gray-900'"
                                        x-text="formatNumber(item.current_stock)">
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Table Footer with Summary -->
                <div class="bg-gray-50 px-6 py-4 border-t-2 border-gray-300">
                    <div class="flex items-center justify-between text-sm">
                        <div class="text-gray-600">
                            共 <span class="font-bold text-gray-900" x-text="childItems.length"></span> 条记录
                        </div>
                        <div class="flex items-center gap-6 text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-red-500 rounded"></div>
                                <span>超领 (负值)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-orange-500 rounded"></div>
                                <span>待入库</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-green-500 rounded"></div>
                                <span>已完成</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div x-show="!loading && childItems.length === 0 && !error" class="text-center py-16">
                <div class="text-gray-400 mb-4">
                    <i class="fas fa-inbox fa-4x"></i>
                </div>
                <h3 class="text-xl font-medium text-gray-600 mb-2">暂无数据</h3>
                <p class="text-gray-500">请输入MTO单号进行查询</p>
            </div>

            <!-- Loading State -->
            <div x-show="loading" class="text-center py-16">
                <div class="inline-block">
                    <i class="fas fa-spinner fa-spin fa-3x text-blue-600 mb-4"></i>
                    <p class="text-gray-600 font-medium">正在查询数据...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Custom JS -->
    <script src="/static/js/app.js"></script>
</body>
</html>
